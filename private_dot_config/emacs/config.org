# -*- visual-fill-column-mode: nil -*-

#+Title:Calum's Emacs Config
#+Author: Calum Sieppert
#+Date: 2021
# Allow evaluation of src blocks without results blocks popping up
#+PROPERTY: header-args :results silent :tangle yes
#+STARTUP: nolatexpreview

This config is based off [[https://github.com/ianpan870102/yay-evil-emacs/blob/master/config.org][this file]].

[[https://github.com/noctuid/general.el/][general.el]] had to be loaded upfront so that the ~:general~ keyword
works.

#+begin_src emacs-lisp
(use-package general
  :config
  (defconst calum/leader "C-c")
  (defconst calum/leader-non-normal "C-c")
  (general-create-definer calum/leader-def
    :prefix calum/leader)
  (general-override-mode)
  )
  #+end_src

* General Emacs Configuration

#+BEGIN_SRC emacs-lisp :tangle yes :noweb yes
(use-package emacs
<<emacs-config>>
)
#+END_SRC

** ~<<emacs-config>>~
:PROPERTIES:
:header-args: :noweb-ref emacs-config :tangle no :results silent
:END:

*** Definitions
#+begin_src emacs-lisp
:preface
(defvar calum/indent-width 4)
(defvar calum/code-font "JetBrains Mono")
(defvar calum/code-font-height 120)
(defvar calum/magit-mode nil)

(defun calum/advise-push-mark-before (func)
  "Advise FUNC to push the current mark before executing."
  (advice-add func :before #'(lambda (&rest _) "push-mark" (push-mark))))

(defun calum/bounds-of-number-at-point ()
  "Based on thingatpt.el's =number-at-point="
  (cond
   ((thing-at-point-looking-at "\\(0x\\|#x\\)\\([a-fA-F0-9]+\\)" 500)
    (cons (match-beginning 2) (match-end 2)))
   ((thing-at-point-looking-at "-?[0-9]+\\.?[0-9]*" 500)
    (cons (match-beginning 0) (match-end 0)))))

(defun calum/copy-binding-for-key (key-list)
  "Prompt for a key and save it's bound command to the kill ring."
  (interactive (list (help--read-key-sequence)))
  (kill-new (symbol-name (key-binding
                          (mapcan (lambda (x) (pcase-let* ((`(,seq . ,raw-seq) x)) raw-seq)) key-list)))))

(defun calum/copy-and-insert-binding-for-key (key-list)
  "Prompt for a key, save it's bound command to the kill ring, and insert it."
  (interactive (list (help--read-key-sequence)))
  (calum/copy-binding-for-key key-list)
  (yank))

(defun unpop-to-mark-command ()
  "Unpop off mark ring. Does nothing if mark ring is empty. https://stackoverflow.com/a/14539202"
  (interactive)
  (when mark-ring
    (setq mark-ring (cons (copy-marker (mark-marker)) mark-ring))
    (set-marker (mark-marker) (car (last mark-ring)) (current-buffer))
    (when (null (mark t)) (ding))
    (setq mark-ring (nbutlast mark-ring))
    (goto-char (marker-position (car (last mark-ring))))))

;; Like the kill-word functions, but don't yank
(defun delete-word (arg)
  "Delete characters forward until encountering the end of a word.
With argument ARG, do this that many times."
  (interactive "p")
  (delete-region (point) (progn (forward-word arg) (point))))

(defun backward-delete-word (arg)
  "Delete characters backward until encountering the beginning of a word.
With argument ARG, do this that many times."
  (interactive "p")
  (delete-word (- arg)))

(defun calum/copy-current-kill-to-clipboard ()
  "https://emacs.stackexchange.com/a/52179"
  (interactive)
  (gui-set-selection 'CLIPBOARD (current-kill 0)))
(defun recentf-ido-find-file ()
  "Find a recent file using Ido. From https://www.emacswiki.org/emacs/RecentFiles#h5o-8"
  (interactive)
  (let ((file (ido-completing-read "Choose recent file: " recentf-list nil t)))
    (when file
      (find-file file))))

(defun calum/edit-config ()
  (interactive)
  (chezmoi-find (concat user-emacs-directory "config.org")))
(defun calum/open-terminal-here ()
  "Based on https://emacs.stackexchange.com/a/7652 for opening a terminal in the folder of the current file"
  (interactive "@")
  (shell-command (concat "terminal --working-directory "
                         (file-name-directory (or load-file-name buffer-file-name))
                         " > /dev/null 2>&1 & disown") nil nil))

(defun buffer-backed-by-file-p (buffer)
  "https://emacs.stackexchange.com/a/35907"
  (let ((backing-file (buffer-file-name buffer)))
    (if (buffer-modified-p buffer)
        t
      (if backing-file
          (file-exists-p (buffer-file-name buffer))
        t))))

(defun kill-removed-buffers ()
  "Kill all buffers whose files have been deleted/moved, from
https://emacs.stackexchange.com/a/35907"
  (interactive)
  (require 'dash)
  (let ((to-kill (-remove 'buffer-backed-by-file-p (buffer-list))))
    (mapc 'kill-buffer to-kill)
    (message "Killed %s buffers" (length to-kill))))

(defun replace-buffer-with-shell-command (command)
  "Pipe the buffer's contents to a shell a command and replace them with its output."
  (let ((temp-point (point)))
    (mark-whole-buffer)
    (shell-command-on-region
     (region-beginning) (region-end) command :replace t)
    (goto-char temp-point)))

(defun wrap-with-direnv-disabled (orig-fun &rest args)
  "Disable direnv for the current folder before calling the function, then re-enable it"
  (direnv-update-directory-environment "~/" nil)
  (apply orig-fun args)
  (direnv-update-environment))

(defun advice-unadvice (sym)
  "Remove all advices from symbol SYM. https://emacs.stackexchange.com/a/24658"
  (interactive "aFunction symbol: ")
  (advice-mapc (lambda (advice _props) (advice-remove sym advice)) sym))

(defun recenter-advice (&rest args) "Recenter the window" (recenter))
#+end_src

*** Keybindings
#+begin_src emacs-lisp
:general
("C-<down-mouse-1>" ;; Ctrl click to open a link
 (lambda (event)
   (interactive (list last-command-event))
   (posn-set-point (event-end event))
   (browse-url (thing-at-point 'url t))))

("<XF86Paste>" (general-key "<paste>"))
("<XF86Copy>" (general-key "<copy>"))
("<XF86Cut>" (general-key "<cut>"))
("C-<backspace>" 'backward-delete-word)
("M-d" 'delete-word)
("C-S-p" 'execute-extended-command)
("C-s" 'save-buffer)
("<f7>" 'calum/edit-config)
("C-M-c" nil)
("C-M-c" 'meow-comment)
(calum/leader-def "t" 'calum/open-terminal-here)
(calum/leader-def :infix "w"
  ;; prefix-command is needed for meow to show a description for the "w" key
  :prefix-command 'windows-map
  "" nil
  ;; Use built-in window moving for cases where evil isn't available
  "h" 'windmove-left
  "l" 'windmove-right
  "k" 'windmove-up
  "j" 'windmove-down
  "w" 'kill-this-buffer
  "c" 'delete-window
  "u" 'winner-undo
  "y" 'winner-redo
  "o" 'delete-other-windows
  "s" 'split-window-horizontally
  "v" 'split-window-vertically)
(calum/leader-def :infix "M"
  :prefix-command 'misc-map
  "" nil
  "w" 'writeroom-mode
  "v" 'calum/copy-current-kill-to-clipboard
  "g" 'calum/git-permalink
  "l" 'calum/git-link
  "i" 'calum/copy-and-insert-binding-for-key
  "c" 'calum/copy-binding-for-key
  )
  #+end_src

*** Variables
#+begin_src emacs-lisp
:custom
(enable-recursive-minibuffers t)
;; Emacs 28: Hide commands in M-x which do not work in the current mode.
(read-extended-command-predicate #'command-completion-default-include-p)
;; Emacs 28; recommended by embark
(y-or-n-p-use-read-key t)
;; Don't use system clipboard by default
(select-enable-clipboard t)
(select-enable-primary nil)
(mouse-drag-copy-region nil)
(initial-scratch-message "")
(set-mark-command-repeat-pop t)
(kill-read-only-ok t)
(kill-do-not-save-duplicates t)
(ring-bell-function 'ignore)
; Allow the emacs window to resize more precisely
(frame-resize-pixelwise t)
; Horizontal mouse scrolling
(mouse-wheel-tilt-scroll t)
; Flip horizontal scrolling
(mouse-wheel-flip-direction t)
; Enable indentation+completion using the TAB key
(tab-always-indent 'complete)
; Don't TAB cycle if there are only a few completion candidates
(completion-cycle-threshold nil)
;; Hide title bar
(default-frame-alist '((undecorated . t)))

;; better scrolling experience
(scroll-margin 0)
(scroll-conservatively 101)
(scroll-preserve-screen-position t)
(auto-window-vscroll nil)

(recentf-max-menu-items 100)
(recentf-max-saved-items 100)

;; Omit default startup screen
(inhibit-startup-screen t)

;; Split windows horizontally
;; https://stackoverflow.com/a/2081978/14703577
(split-width-threshold 0)
(split-height-threshold nil)
;; Windows at the time of writing are 192 columns, so this ensures
;; that windows can be split horizontally only once, and (with the
;; above settings) when another window is opened for whatever reason,
;; it either splits the frame in two horizontally, or takes the other
;; half of the frame.
(window-min-width 80)

;; Increased because desktop mode was running into the limit after
;; adding dirvish
(max-lisp-eval-depth 5000)

;; Recommended by lsp-mode https://emacs-lsp.github.io/lsp-mode/page/performance/
(gc-cons-threshold 100000000)
(read-process-output-max (* 1024 1024)) ;; 1mb

;; Recommended here: https://github.com/integral-dw/org-superstar-mode#this-mode-causes-significant-slowdown
(inhibit-compacting-font-caches t)

(compilation-scroll-output t)

;; Don't keep =kill-this-buffer= in =repeat= blacklist
(repeat-too-dangerous nil)
#+end_src

*** Config
#+begin_src emacs-lisp
:config
(put 'number 'bounds-of-thing-at-point 'calum/bounds-of-number-at-point)

(advice-add 'browse-url :around #'wrap-with-direnv-disabled)

(advice-add 'compile-goto-error :after #'recenter-advice)
(advice-add 'next-error :after #'recenter-advice)
(advice-add 'previous-error :after #'recenter-advice)

(setq-default
 word-wrap t
 ;; Always use spaces for indentation
 indent-tabs-mode nil
 tab-width calum/indent-width)

(if (member "--magit" command-line-args)
    (progn
      (setq command-line-args (delete "--magit" command-line-args))
      (setq calum/magit-mode t)
      ;; Shows "magit <git repo>" as the frame title when Magit is open
      (setq frame-title-format "%b")))

;; https://www.emacswiki.org/emacs/TransparentEmacs#h5o-1
(set-frame-parameter (selected-frame) 'alpha '(95 . 95))
;; Make sure emacsclient frames are made transparent as well
(add-hook 'after-make-frame-functions
          #'(lambda (frame)
              (set-frame-parameter frame 'alpha '(95 . 95))
              (set-scroll-bar-mode nil)))
(add-to-list 'default-frame-alist '(alpha . (95 . 95)))

;; Clean unused buffer every day at midnight
(midnight-mode 1)

;; Save command history between sessions
(savehist-mode 1)
;; Restore buffer point position when reopening buffers
(save-place-mode 1)

(tool-bar-mode -1)
(menu-bar-mode -1)
;; Allow opening recent files
;; https://www.emacswiki.org/emacs/RecentFiles
(recentf-mode 1)
#+END_SRC

* Configuration for built-in packages

** Project.el
#+begin_src emacs-lisp
(use-package project
  :ensure nil
  :preface
  ;; https://zerokspot.com/weblog/2019/11/27/eglot-projects-not-in-vcs-root/
  (defun my-projectile-project-find-function (dir)
    (let ((root (projectile-project-root dir)))
      (and root (cons 'transient root))))
  :config
  (add-to-list 'project-find-functions 'my-projectile-project-find-function))
#+end_src

** Syntax checking with flymake
#+begin_src emacs-lisp
(use-package flymake
  :ensure nil
  :general
  (:keymaps 'flymake-mode-map
            "M-n" 'flymake-goto-next-error
            "M-p" 'flymake-goto-prev-error)
  :config
  (calum/advise-push-mark-before 'flymake-goto-next-error)
  (calum/advise-push-mark-before 'flymake-goto-prev-error))
#+end_src

** Simple completion with dabbrev
#+begin_src emacs-lisp
(use-package dabbrev
  :custom
  (dabbrev-ignored-buffer-regexps '("\\.\\(?:pdf\\|jpe?g\\|png\\)\\'"))
  (dabbrev-case-replace nil))
#+end_src

** Window config history
Undo/redo window configuration changes using ~C-c <left>~ / ~C-c <right>~.
#+begin_src emacs-lisp
(use-package winner
  :ensure nil
  :config
  (winner-mode 1))
#+end_src

** Compilation colours
Enable terminal colours in the compilation buffer. From https://stackoverflow.com/a/71785402
#+begin_src emacs-lisp
(use-package ansi-color
    :hook (compilation-filter . ansi-color-compilation-filter))
#+end_src

** Disable scroll-bar

#+BEGIN_SRC emacs-lisp
(use-package scroll-bar
  :ensure nil
  :config (set-scroll-bar-mode nil))
#+END_SRC

** File-related tweaks

Don’t bother confirming killing processes and don’t let backup~ files scatter around.

#+begin_src emacs-lisp
(use-package files
  :ensure nil
  :config
  (setq confirm-kill-processes nil
        create-lockfiles nil ; don't create .# files
        make-backup-files nil))
#+end_src

** Clean up whitespace on save
#+BEGIN_SRC emacs-lisp
(use-package whitespace
  :ensure nil
  :hook (before-save . whitespace-cleanup))
#+END_SRC
** Font

See [[*Load theme][Load theme]] for additional font selection with the poet theme.
#+BEGIN_SRC emacs-lisp
(use-package frame
  :ensure nil
  :config
  (set-face-attribute 'default nil
                      :family calum/code-font
                      :height calum/code-font-height
                      :weight 'normal))
#+END_SRC
** Mouse wheel (track-pad) scroll speed
By default, the scrolling is way too fast to be precise and helpful,
let's tune it down a little bit.
#+BEGIN_SRC emacs-lisp
(use-package mwheel
  :ensure nil
  :config (setq mouse-wheel-scroll-amount '(2 ((shift) . 1))
                mouse-wheel-progressive-speed nil))
#+END_SRC
** Automatically refreshes the buffer for changes outside of Emacs
Auto refreshes every 2 seconds. Don't forget to refresh the version
control status as well.
#+BEGIN_SRC emacs-lisp
(use-package autorevert
  :ensure nil
  :config
  (global-auto-revert-mode +1)
  (setq auto-revert-interval 2
        auto-revert-check-vc-info t
        global-auto-revert-non-file-buffers t
        auto-revert-verbose nil))
#+END_SRC
** Spell Check

Turn on spell checking for text modes and configure keybindings under
~C-c s~.
#+begin_src emacs-lisp
(use-package flyspell
  :ensure nil
  :delight
  :preface
  (defun flyspell-check-next-highlighted-word ()
    "Custom function to spell check next highlighted word
Based off https://www.emacswiki.org/emacs/FlySpell#h5o-7"
    (interactive)
    (let ((previous-point (point)))
      (flyspell-goto-next-error)
      (ispell-word)
      (goto-char previous-point)))
  :general
  (calum/leader-def
    :infix "s"
    :prefix-command 'spell-check-map
    "t" '(flyspell-mode
          :which-key "toggle spell check")
    "p" '(flyspell-check-previous-highlighted-word
          :which-key "spell check previous word")
    "n" '(flyspell-check-next-highlighted-word
          :which-key "spell check next word")
    "b" '(ispell-buffer
          :which-key "spell check buffer")))
#+end_src
** Eldoc
Just disabling the display in the mode-bar.
#+begin_src emacs-lisp
(use-package eldoc
  :delight)
#+end_src
** Ediff
Make ediff not use a new frame for the control window, it doesn't play
nicely with xmonad.
#+begin_src emacs-lisp
(use-package ediff
  :config
  (setq ediff-window-setup-function 'ediff-setup-windows-plain))
#+end_src
** Latex
#+begin_src emacs-lisp
(use-package tex-mode
  :preface
  (defun latexindent-format-buffer ()
    (interactive)
    (replace-buffer-with-shell-command "latexindent")
    (recenter))
  :hook
  (TeX-mode . visual-line-mode)
  (TeX-mode . visual-fill-column-mode)
  ;; Format before save, based on https://emacs.stackexchange.com/a/5777
  (TeX-mode . (lambda () (add-hook 'before-save-hook 'latexindent-format-buffer nil 'local)))
  :config
  (setq tab-width 4))
#+end_src
* Third-party packages

** GUI enhancements
*** Load theme
Doom Nord theme
#+begin_src emacs-lisp
(use-package doom-themes
  :custom
  (doom-nord-brighter-modeline nil)
  (doom-nord-brighter-comments t)
  (doom-nord-comment-bg nil)
  (doom-nord-region-highlight t)
  :config
  (load-theme 'doom-nord t))
#+end_src

*** Syntax highlighting
Lightweight syntax highlighting improvement for numbers and escape
sequences (e.g. ~\n, \t~).
#+BEGIN_SRC emacs-lisp
  (use-package highlight-numbers
    :hook (prog-mode . highlight-numbers-mode))

  (use-package highlight-escape-sequences
    :hook (prog-mode . hes-mode))
#+END_SRC

*** Unicode fonts
Makes sure fonts for various icons are found:
https://github.com/rolandwalker/unicode-fonts

#+begin_src emacs-lisp
(use-package unicode-fonts
  :config
  (unicode-fonts-setup))
#+end_src

** Git Integration
*** Magit
See [[https://github.com/emacs-evil/evil-collection/blob/d1dec4ef730554a2b9d5b96098abf166685aaa38/modes/magit/evil-collection-magit.el#L289][here]] for useful mappings and commands
#+BEGIN_SRC emacs-lisp
(use-package magit
  :init
  (setq forge-add-default-bindings t)
  :general
  (calum/leader-def
    :keymaps 'override
    "g" '(magit-status :which-key "magit"))
  (:keymaps 'magit-mode-map
            "C-SPC" 'magit-diff-show-or-scroll-up
            "x" 'magit-delete-thing
            ;; Shift-tab
            "<backtab>" 'magit-section-cycle)
  :delight magit-wip-mode
  :preface
  (defun magit-choose ()
    "Choose git repo then open magit status
  From here https://github.com/magit/magit/issues/3139#issuecomment-319047034"
    (interactive)
    (let ((current-prefix-arg t))
      (call-interactively 'magit-status)))
  :config
  (if calum/magit-mode
      (progn
        ;; Open Magit in full screen
        (setq magit-display-buffer-function #'magit-display-buffer-fullframe-status-v1)))

  ;; Automatically put us in full insert mode for commit editing
  (add-hook 'with-editor-mode-hook #'meow-insert)

  ;; Update commit views when scrolling through commits in status
  (add-hook 'magit-section-movement-hook 'magit-status-maybe-update-revision-buffer)

  ;; https://github.com/dgutov/diff-hl#magit
  (add-hook 'magit-pre-refresh-hook 'diff-hl-magit-pre-refresh)
  (add-hook 'magit-post-refresh-hook 'diff-hl-magit-post-refresh)

  ;; https://magit.vc/manual/magit/Wip-Modes.html
  (magit-wip-mode 1)

  (setq magit-diff-refine-hunk t
        )

  ;; From the mamual on magit-branch-or-checkout
  (transient-replace-suffix 'magit-branch 'magit-checkout
    '("b" "dwim" magit-branch-or-checkout))
  (transient-append-suffix 'magit-log "-L"
    '("-m" "Omit merge commits" "--no-merges"))
  (transient-append-suffix 'magit-log-refresh "-L"
    '("-m" "Omit merge commits" "--no-merges"))
  )
#+END_SRC

https://github.com/dandavison/magit-delta
Slows down magit alot, and breaks the display, seemingly due to large
file (a package-lock.json)
#+begin_src emacs-lisp
;; (use-package magit-delta
;;   :hook (magit-mode . magit-delta-mode))
#+end_src

*** Forge
[[https://magit.vc/manual/forge/index.html#Top][Forge]] for Github integration in Magit. Expects the ~~/.authinfo~ file
to have been properly filled with the Github key (see the forge
documentation).
#+begin_src emacs-lisp
  (use-package forge
    :after magit
    :config
    (setq auth-sources '("~/.config/emacs/.authinfo")
          forge-owned-accounts '(("rynoV") nil)))
#+end_src

*** Code Review
#+begin_src emacs-lisp
(use-package code-review
  :general
  (calum/leader-def :keymaps 'forge-topic-mode-map
            "r" 'code-review-forge-pr-at-point
            )
  (calum/leader-def :keymaps 'code-review-mode-map
            "M-n" 'code-review-comment-jump-next
            "M-p" 'code-review-comment-jump-previous
            )
  :config
  (add-hook 'code-review-mode-hook #'emojify-mode)
  (setq code-review-fill-column 80)
  (setq code-review-auth-login-marker 'forge))
#+end_src

*** Git Gutter (via diff-hl)
#+begin_src emacs-lisp
(use-package diff-hl
  :config
  (global-diff-hl-mode)
  (diff-hl-flydiff-mode))
#+end_src

** Text editing
*** Meow
#+begin_src emacs-lisp
(general-define-key
 "C-M-n" nil
 "C-M-p" nil
 "C-M-n" 'next-line
 "C-M-p" 'previous-line)
(use-package meow
  :demand t                   ; Necessary because :hook defers loading
  :preface
  (defun calum/meow-escape ()
    "Quit INSERT or quit minibuffer or do nothing. From https://github.com/meow-edit/meow/discussions/186#discussioncomment-1999930"
    (interactive)
    (cond
     ((meow-insert-mode-p)
      (meow-insert-exit))
     ((minibufferp)
      (keyboard-escape-quit))
     (t)))

  (defun calum/meow-pop-to-mark ()
    "Go back through the mark ring."
    (interactive)
    (set-mark-command 4)
    (recenter))
  (defun calum/meow-setup ()
    (interactive)
    (setq meow-cheatsheet-layout meow-cheatsheet-layout-qwerty
          meow--kbd-forward-line "C-M-n"
          meow--kbd-backward-line "C-M-p"
          meow-use-dynamic-face-color t
          meow-expand-exclude-mode-list nil)

    (meow-motion-overwrite-define-key
     '("j" . meow-next)
     '("k" . meow-prev)
     '("'" . calum/avy-map)
     '("<escape>" . ignore))
    (meow-leader-define-key
     ;; SPC j/k will run the original command in MOTION state.
     '("j" . "H-j")
     '("k" . "H-k")
     ;; Use SPC (0-9) for digit arguments.
     '("1" . meow-digit-argument)
     '("2" . meow-digit-argument)
     '("3" . meow-digit-argument)
     '("4" . meow-digit-argument)
     '("5" . meow-digit-argument)
     '("6" . meow-digit-argument)
     '("7" . meow-digit-argument)
     '("8" . meow-digit-argument)
     '("9" . meow-digit-argument)
     '("0" . meow-digit-argument)
     '("/" . meow-keypad-describe-key)
     '("?" . meow-cheatsheet))
    (meow-normal-define-key
     '("0" . meow-expand-0)
     '("9" . meow-expand-9)
     '("8" . meow-expand-8)
     '("7" . meow-expand-7)
     '("6" . meow-expand-6)
     '("5" . meow-expand-5)
     '("4" . meow-expand-4)
     '("3" . meow-expand-3)
     '("2" . meow-expand-2)
     '("1" . meow-expand-1)
     '("/" . meow-visit)
     '("?" . nil)
     '("-" . negative-argument)
     '(";" . meow-reverse)
     '("," . meow-inner-of-thing)
     '("." . meow-bounds-of-thing)
     '(">" . repeat)
     '("<" . calum/meow-pop-to-mark)
     '("[" . meow-beginning-of-thing)
     '("]" . meow-end-of-thing)
     '("$" . calum/query-replace-map)
     '("a" . meow-append)
     '("A" . meow-open-below)
     '("b" . meow-back-word)
     '("B" . meow-back-symbol)
     '("c" . meow-change-save)
     '("C" . comment-line)
     '("d" . meow-delete)
     '("D" . meow-kill-whole-line)
     '("e" . meow-next-word)
     '("E" . meow-next-symbol)
     '("f" . meow-find-expand)
     '("F" . display-local-help)
     '("g" . meow-cancel-selection)
     '("G" . meow-grab)
     '("h" . meow-left)
     '("H" . meow-left-expand)
     '("i" . meow-insert)
     '("I" . meow-open-above)
     '("j" . meow-next)
     '("J" . meow-next-expand)
     '("k" . meow-prev)
     '("K" . meow-prev-expand)
     '("l" . meow-right)
     '("L" . meow-right-expand)
     '("m" . meow-join)
     '("n" . meow-search)
     '("N" . meow-nav-mode)
     '("o" . meow-block)
     '("O" . meow-to-block)
     '("p" . meow-yank)
     '("P" . meow-paren-mode)
     '("q" . meow-quit)
     '("Q" . meow-goto-line)
     '("r" . meow-replace)
     '("R" . meow-swap-grab)
     '("s" . meow-kill)
     '("t" . meow-till-expand)
     '("u" . meow-undo)
     '("U" . undo-tree-redo)
     '("v" . meow-find-ref)
     '("V" . meow-pop-marker)
     '("w" . meow-mark-word)
     '("W" . meow-mark-symbol)
     '("x" . meow-line)
     '("X" . join-line)
     '("y" . meow-save)
     '("Y" . meow-sync-grab)
     '("z" . calum/paren-map)
     '("Z" . meow-pop-selection)
     '("'" . calum/avy-map)
     '("\"" . calum/mc-map)
     '("<escape>" . calum/meow-escape)
     '("<f4>" . meow-kmacro-lines)
     '("<f5>" . meow-kmacro-matches)))

  (defun calum/meow--minibuffer-setup ()
    "meow--minibuffer-setup but without the code to disable meow text editing"
    (when (or (member this-command meow-grab-fill-commands)
              (member meow--keypad-this-command meow-grab-fill-commands))
      (when-let ((s (meow--second-sel-get-string)))
        (insert s)))
    (meow-insert-mode))

  (defvar meow-nav--direction 'forward "Which direction the movement commands should move")

  (defun meow-nav--update-modeline ()
    "Update the modeline to show the current direction."
    (delight 'meow-nav-mode (if (equal 'forward meow-nav--direction) " [NAV]+" " [NAV]-") t)
    (force-mode-line-update))

  (defun meow-nav-swap-direction ()
    "Swap the movement direction"
    (interactive)
    (setq meow-nav--direction (if (equal 'forward meow-nav--direction) 'backward 'forward))
    (meow-nav--update-modeline))

  (defun calum/diff-hl-previous-hunk (arg)
    "Like its namesake, but takes a prefix argument to determine how many hunks to move."
    (interactive "p")
    (dotimes (i (abs arg))
      (diff-hl-previous-hunk)))

  (defun calum/diff-hl-next-hunk (arg)
    "Like its namesake, but takes a prefix argument to determine how many hunks to move."
    (interactive "p")
    (message (number-to-string arg))
    (dotimes (i (abs arg))
      (diff-hl-next-hunk)))

  (defmacro meow-nav--mk-movement (fwd bkwd name doc)
    `(defun ,name (arg)
       ,doc
       (interactive "P")
       (let ((current-prefix-arg arg))
         (call-interactively
          (if (equal 'forward meow-nav--direction) ,fwd ,bkwd)))))

  (meow-nav--mk-movement 'end-of-defun 'beginning-of-defun meow-nav-move-defun "Move by function definition")
  (meow-nav--mk-movement 'View-scroll-half-page-forward 'View-scroll-half-page-backward meow-nav-move-half-page "Move by half pages")
  (meow-nav--mk-movement 'next-error 'previous-error meow-nav-move-error "Move by compilation-mode errors")
  (meow-nav--mk-movement 'flymake-goto-next-error 'flymake-goto-prev-error meow-nav-move-flymake-error "Move by flymake errors")
  (meow-nav--mk-movement 'View-scroll-line-forward 'View-scroll-line-backward meow-nav-move-line "Scroll single lines")
  (meow-nav--mk-movement 'calum/diff-hl-next-hunk 'calum/diff-hl-previous-hunk meow-nav-move-hunk "Move by version control hunk")
  (meow-nav--mk-movement 'scroll-left 'scroll-right meow-nav-move-scroll-horizontal "Scroll left/right")
  (meow-nav--mk-movement 'scroll-other-window 'scroll-other-window-down meow-nav-move-scroll-other "Scroll other window")

  (defun calum/meow-setup-extra ()
    ;; From
    ;; https://github.com/meow-edit/meow/discussions/186#discussioncomment-1999930,
    ;; to allow using normal mode in minibuffer
    ;; Don't ignore cursor shape changes in minibuffer
    (delete (cons 'minibufferp 'meow--update-cursor-default)
            meow-update-cursor-functions-alist)
    ;; Remove default minibuffer setup
    (remove-hook 'minibuffer-setup-hook 'meow--minibuffer-setup)
    ;; Use INSERT state in minibuffer by default, then later we can
    ;; switch to NORMAL with ESC
    (add-hook 'minibuffer-setup-hook 'calum/meow--minibuffer-setup)

    ;; Add more built-in "thing"s for meow to use. For example, select
    ;; a url with ". u". Note: "number" didn't have a
    ;; 'bounds-of-thing-at-point definition, so I added one further up
    ;; this file
    (cl-loop for charthing in '((?\s . whitespace) (?n . number) (?@ . email) (?f . filename) (?u . url)) do
             (let ((thing (cdr charthing)))
               (meow-thing-register thing thing thing)
               (add-to-list 'meow-char-thing-table charthing)))
    ;; Use ; to reverse search, or reverse point and mark when selection is active
    (add-to-list 'meow-selection-command-fallback '(meow-reverse . negative-argument))
    ;; Use <f4> to execute the current macro on each line in the
    ;; selection, or if no selection just call the macro
    (add-to-list 'meow-selection-command-fallback '(meow-kmacro-lines . meow-end-or-call-kmacro))

    ;; Custom state for navigation only. Uses view-mode to disallow
    ;; editing and enable special navigation functions. Keymap is
    ;; based on normal state, but overrides keys that change text to
    ;; use them for navigation. Tries to keep all other normal state
    ;; keys the same. The mode keeps track of a current "direction",
    ;; and one key swaps the direction. Keys make movements
    ;; "backwards" or "forwards" depending on the current direction;
    ;; what backwards and forwards mean depends on the movement. This
    ;; model saves on keybinding space and eases binding memorization,
    ;; as I only have to remember one key per movement type, and when
    ;; I want to switch direction I use the same key every time.
    (setq meow-nav-keymap (make-composed-keymap (copy-keymap meow-normal-state-keymap) 'view-mode-map))
    (meow-define-state nav
      "Meow state for navigating files and selecting text."
      :lighter " [NAV]"
      :keymap meow-nav-keymap
      (cond
       (meow-nav-mode
        (view-mode 1)
        (meow-nav--update-modeline))
       (t (view-mode -1))))

    (setq meow-cursor-type-nav 'hollow)

    (meow-define-keys 'nav
      '("<escape>" . meow-normal-mode)
      '("N" . meow-normal-mode)
      ;; Bind upper and lower so I can swap direction without lifting
      ;; shift key if needed
      '("a" . meow-nav-swap-direction)
      '("A" . meow-nav-swap-direction)
      '("d" . meow-nav-move-defun)
      '("p" . meow-nav-move-half-page)
      '("c" . meow-nav-move-hunk)
      '("q" . meow-nav-move-flymake-error)
      '("u" . meow-nav-move-error)
      '("i" . meow-nav-move-line)
      '("P" . meow-nav-move-scroll-horizontal)
      '("R" . meow-nav-move-scroll-other)
      ;; '("r" . ?)
      ;; '("m" . ?)
      '("Z" . recenter-top-bottom))
    (add-to-list 'minor-mode-overriding-map-alist (cons 'meow-nav-mode meow-nav-keymap))

    (setq meow-paren-keymap 'calum/paren-map)
    (meow-define-state paren
      "meow state for interacting with smartparens"
      :lighter " [P]"
      :keymap meow-paren-keymap)

    (setq meow-cursor-type-paren 'bar)

    (meow-define-keys 'paren
      '("<escape>" . meow-normal-mode)
      '("u" . meow-undo)
      '("-" . negative-argument))
    (add-to-list 'minor-mode-overriding-map-alist (cons 'meow-nav-mode meow-nav-keymap)))
  :hook
  (meow-global-mode . calum/meow-setup-extra)
  (meow-mode . calum/meow-setup-extra)
  :config
  (setq meow-keypad-leader-dispatch calum/leader)
  (calum/meow-setup)
  (meow-global-mode 1))
#+end_src

*** Edit surrounding pairs (smartparens)
#+begin_src emacs-lisp
(use-package smartparens
  :delight
  :init
  (define-prefix-command 'calum/paren-map)
  :preface
  (defmacro def-pairs (pairs)
    "Define functions for pairing. PAIRS is an alist of (NAME . STRING)
conses, where NAME is the function name that will be created and
STRING is a single-character string that marks the opening character.

  (def-pairs ((paren . \"(\")
              (bracket . \"[\"))

defines the functions WRAP-WITH-PAREN and WRAP-WITH-BRACKET,
respectively.

From https://ebzzry.com/en/emacs-pairs/"
    `(progn
       ,@(loop for (key . val) in pairs
               collect
               `(defun ,(read (concat "wrap-with-" (prin1-to-string key) "s"))
                    (&optional arg)
                  (interactive "p")
                  (sp-wrap-with-pair ,val)))))

  (def-pairs ((single-quote . "'")
              (double-quote . "\"")
              (back-quote . "`")))
  :general
  (:keymaps 'calum/paren-map
            "s" 'sp-wrap-square
            "c" 'sp-wrap-curly
            "r" 'sp-wrap-round
            "'" 'wrap-with-single-quotes
            "\"" 'wrap-with-double-quotes
            "`" 'wrap-with-back-quotes
            "d" 'sp-splice-sexp
            "w" 'sp-rewrap-sexp
            "l" 'sp-forward-sexp
            "L" 'sp-slurp-hybrid-sexp
            "h" 'sp-backward-sexp
            "H" 'sp-highlight-current-sexp
            "j" 'sp-down-sexp
            "k" 'sp-up-sexp
            "K" 'sp-kill-hybrid-sexp
            "n" 'sp-next-sexp
            "p" 'sp-previous-sexp
            "P" 'sp-push-hybrid-sexp
            "b" 'sp-beginning-of-sexp
            "e" 'sp-end-of-sexp
            ">" 'sp-beginning-of-next-sexp
            "<" 'sp-end-of-previous-sexp
            "D" 'sp-kill-sexp
            "y" 'sp-copy-sexp
            "," 'sp-transpose-sexp
            "o" 'sp-select-next-thing
            "O" 'sp-select-next-thing-exchange
            "S" 'sp-split-sexp
            "J" 'sp-join-sexp
            "t" 'sp-transpose-sexp
            "T" 'sp-transpose-hybrid-sexp
            "a" 'sp-add-to-next-sexp
            "A" 'sp-add-to-previous-sexp
            "v" 'sp-forward-slurp-sexp
            "V" 'sp-forward-barf-sexp
            "." 'sp-convolute-sexp
            ";" 'sp-comment
            "c" '(lambda () (interactive) (sp-change-enclosing) (meow-insert-mode))
            "C" '(lambda () (interactive) (sp-change-inner) (meow-insert-mode))
            "x" 'sp-extract-after-sexp
            "X" 'sp-extract-before-sexp
            "!" 'sp-prefix-pair-object
            "@" 'sp-prefix-save-excursion
            "#" 'sp-prefix-symbol-object
            "$" 'sp-prefix-tag-object)
  :config
  (require 'smartparens-config)
  (smartparens-global-mode)
  (show-smartparens-global-mode))
#+end_src
*** Structural editing
#+begin_src emacs-lisp
(use-package tree-sitter
  :config
  (add-to-list 'tree-sitter-major-mode-language-alist '(purescript-mode . haskell)))
(use-package tree-sitter-langs)
#+end_src

**** Combobulate
https://github.com/mickeynp/combobulate uses tree sitter for
navigation and editing, still early stages project. Will require setup
for whatever languages I want.
#+begin_src emacs-lisp
(use-package combobulate
  :quelpa (combobulate :fetcher github :repo "mickeynp/combobulate")
  ;; Ensure `combobulate-mode` is activated when you launch a mode it supports
  ;; :hook
  ;; (purescript-mode . combobulate-mode)
  :preface
  (defun combobulate-setup-purescript ()
    (setq combobulate-manipulation-node-cluster-queries
          '((function_definition . (haskell (signature (_)) @match (function (_))))))
    (setq combobulate-navigation-node-types '(module
                                              function
                                              )))
  :config
  ;; (add-to-list 'combobulate-setup-functions-alist '(purescript-mode . combobulate-setup-purescript))
  )
#+end_src

*** Repeated edits

**** Multiple Cursors
https://github.com/magnars/multiple-cursors.el
#+begin_src emacs-lisp
(use-package multiple-cursors
  :general
  (:prefix-command 'calum/mc-map
                   "e" 'mc/edit-lines
                   "n" 'mc/cycle-forward
                   "p" 'mc/cycle-backward
                   "h" 'mc/edit-beginnings-of-lines
                   "l" 'mc/edit-ends-of-lines
                   "j" 'mc/mark-next-like-this
                   "k" 'mc/mark-previous-like-this
                   "m" 'mc/mark-more-like-this-extended
                   "a" 'mc/mark-all-dwim
                   "d" 'mc/mark-all-like-this-in-defun
                   )
  (:keymaps 'mc/keymap "<return>" nil)
  :custom
  (mc/edit-lines-empty-lines 'ignore))
#+end_src

**** Visual Regexp
https://github.com/benma/visual-regexp.el/
#+begin_src emacs-lisp
(use-package visual-regexp
  :general
  (:prefix-command 'calum/query-replace-map
                   "$" 'vr/replace
                   "m" 'vr/mc-mark
                   "q" 'vr/query-replace)
  :preface
  ;; Workaround to replace in the whole buffer
  ;; https://github.com/benma/visual-regexp.el/issues/16#issuecomment-877800085
  (defun vr--use-whole-buffer ()
    (unless (region-active-p) (setq vr--target-buffer-start (point-min))))
  :config
  (advice-add 'vr--set-target-buffer-start-end :after 'vr--use-whole-buffer)
  (calum/advise-push-mark-before 'vr/replace)
  (calum/advise-push-mark-before 'vr/mc-mark)
  (calum/advise-push-mark-before 'vr/query-replace))
#+end_src

** Org Mode
:PROPERTIES:
:ID:       14d53b60-22e4-416a-807d-33d001476862
:END:
*** General Setup
Documentation:
- [[help:org-capture-templates][Capture templates]]
- [[help:org-refile-targets][Org refile]]
- [[https://github.com/cdominik/cdlatex][CDLatex]]
- [[https://orgmode.org/manual/CDLaTeX-mode.html][CDLatex Org Mode]]
- [[info:org#Setting options][info:org#Setting options]]


Configures [[https://mobileorg.github.io/][Org Mobile]] syncing so I can write and view notes on my
IPhone. This requires [[https://rclone.org/docs/][rclone]] to be setup with a Dropbox provider named
~dropbox~.

#+begin_src emacs-lisp
(use-package cdlatex
  :if (not calum/magit-mode)
  :custom
  (cdlatex-make-sub-superscript-roman-if-pressed-twice t)
  (cdlatex-math-symbol-alist '((?\" ("\\cap"))))
  )
#+end_src

#+BEGIN_SRC emacs-lisp :tangle yes :noweb yes
(use-package org
  :if (not calum/magit-mode)
  :ensure auctex
  :ensure cdlatex
  :delight
  (visual-line-mode)
  (auto-fill-function)                  ; Hide auto fill mode
<<org-config>>
)
#+END_SRC

**** ~<<org-config>>~
:PROPERTIES:
:header-args: :noweb-ref org-config :tangle no :results silent
:END:

***** Hooks
#+begin_src emacs-lisp
  :hook ((org-mode . visual-line-mode)
         ;; (org-mode . org-indent-mode)
         ;; org-cdlatex-mode is useful for working with latex in org
         (org-mode . turn-on-org-cdlatex)
         ;; Wrap lines visually at the fill column
         ;; (org-mode . visual-fill-column-mode)
         (org-mode . auto-fill-mode)
         ;; (org-mode . calum/set-keyword-faces-org)
         (org-metaleft . calum/org-metaleft-hook)
         (org-metaright . calum/org-metaright-hook))
  #+end_src

***** Definitions
#+begin_src emacs-lisp
  :preface
  (defvar calum/todo-super-agenda-groups '((:auto-outline-path t)))

  (defun calum/set-keyword-faces-org ()
    "https://hugocisneros.com/org-config/#hide-face-characters"
    (mapc (lambda (pair) (push pair prettify-symbols-alist))
          '(("TODO" .     "")
            ("DONE" .     "")
            ("#+begin_quote" . "“")
            ("#+end_quote" . "”")))
    (prettify-symbols-mode +1)
    )

  (defun calum/paste-html-to-org ()
    "Take content from clipboard that can be converted to HTML and paste it as Org mode text using Pandoc

Based off this https://github.com/howardabrams/dot-files/blob/master/emacs-org.org#better-pasting"
    (interactive)
    (let ((text (shell-command-to-string "xclip -out -selection 'clipboard' -t text/html | pandoc -f html -t org")))
      (kill-new text)
      (yank)))
  (defun calum/org-at-item-p ()
    (or (org-in-item-p)
        (and (org-region-active-p)
             (save-excursion
               (goto-char (region-beginning))
               (org-in-item-p)))))

  (defun calum/org-metaleft-hook ()
    (if (calum/org-at-item-p)
        (call-interactively 'org-outdent-item-tree)))

  (defun calum/org-metaright-hook ()
    (if (calum/org-at-item-p)
        (call-interactively 'org-indent-item-tree)))

  (defun calum/insert-subscript (arg)
    "Insert org/latex subscript
Intended for use with 'cdlatex-tab'.
Use numeric prefix arg to insert number."
    (interactive "P")
    (insert (concat "_{" (if arg (format "%s" arg)) "}"))
    (backward-char 1))

  (defun calum/insert-superscript (arg)
    "Insert org/latex superscript
Intended for use with 'cdlatex-tab'
Use numeric prefix arg to insert number."
    (interactive "P")
    (insert (concat "^{" (if arg (format "%s" arg)) "}"))
    (backward-char 1))

  (defun calum/org-mobile-pull ()
    "Uses dropbox and rclone to pull changes from org mobile"
    (interactive)
    (message "Pulling changes from dropbox")
    (call-process-shell-command "rclone sync --fast-list dropbox: ~/Dropbox")
    (message "Done pulling")
    (org-mobile-pull)
    (org-save-all-org-buffers))

  (defun calum/org-mobile-push ()
    "Uses dropbox and rclone to push changes to org mobile"
    (interactive)
    (org-super-agenda-mode 0)
    (org-mobile-push)
    (message "Pushing changes to dropbox")
    (call-process-shell-command "rclone sync --fast-list ~/Dropbox dropbox:")
    (message "Done")
    (org-super-agenda-mode 1))

  (defun calum/org-mobile-sync ()
    "Uses dropbox and rclone to pull then push changes to org mobile"
    (interactive)
    (calum/org-mobile-pull)
    (calum/org-mobile-push))

  (defun calum/open-heading-links ()
    (interactive)
    (save-excursion
      (while (org-up-heading-safe))
      (org-open-at-point)))

  (defun calum/capture-frame-finish (&rest args)
    (interactive)
    (if (equal "Org Capture" (frame-parameter nil 'name))
        (delete-frame)))

  (defun calum/capture-frame-delete-other-windows (&rest args)
    (interactive)
    (if (equal "Org Capture" (frame-parameter nil 'name))
        (delete-other-windows)))

  (defun calum/capture-frame (keys)
    (interactive)
    (require 'org-capture)
    (advice-add 'org-capture-finalize :after #'calum/capture-frame-finish)
    (advice-add 'org-switch-to-buffer-other-window :after #'calum/capture-frame-delete-other-windows)
    (org-capture nil keys))

(defun calum/rerun-org-export ()
  "Rerun the previous export command"
  (interactive)
  (let ((current-prefix-arg '(4)))
    (call-interactively 'org-export-dispatch)))
#+end_src

***** Keybinds
#+begin_src emacs-lisp
  :general
  (calum/leader-def
    :keymaps 'override
    "v" 'calc-dispatch)
  (calum/leader-def
    :infix "o"
    :prefix-command 'org-actions-map
    "a" 'org-agenda
    "l" 'org-store-link
    "c" 'org-capture
    "j" '(org-journal-new-entry :which-key "new journal entry")
    "d" 'org-decrypt-entry
    "e" 'org-encrypt-entry
    "p" 'calum/org-mobile-push
    "f" 'calum/org-mobile-pull
    "s" 'calum/org-mobile-sync
    "o" 'calum/open-heading-links
    "i" 'org-download-clipboard
    "h" 'calum/paste-html-to-org
    "t" 'org-toggle-inline-images
    "r" '(nil :prefix-command org-restart-actions-map)
    "r e" 'calum/rerun-org-export
    "r r" 'org-mode-restart
    "r s" 'org-superstar-restart)
  (:keymaps 'org-mode-map
            ;; Use return to insert a new item when at an item, behave
            ;; normally otherwise. When at an item and a newline is
            ;; needed, use C-j
            "RET" (general-predicate-dispatch 'org-return
                    (and (eolp) (calum/org-at-item-p)) 'org-meta-return))
  (:keymaps 'org-mode-map
            :predicate '(meow-insert-mode-p)
            "C-d" 'cdlatex-tab
            "C-s" 'calum/insert-superscript
            "C-M-s" 'calum/insert-subscript)
#+end_src

***** Faces
See [[https://www.nordtheme.com/docs/colors-and-palettes]] for colours.

  #+begin_src emacs-lisp
:custom-face
(org-level-3 ((nil :height 1.1)))
(org-level-2 ((nil :height 1.2)))
(org-level-1 ((nil :height 1.3)))
(org-ellipsis ((nil :inherit 'org-level-8 :foreground "#D8DEE9")))
  #+end_src

***** Variables
#+begin_src emacs-lisp
:custom
(org-ellipsis " ⤸ ")
(org-hidden-keywords nil)
(org-cycle-level-faces nil)
(org-n-level-faces 4)
(org-pretty-entities t)
(org-startup-indented nil)
;; Add refiled items to the top of lists instead of the bottom
(org-reverse-note-order t)
(org-latex-compiler "xelatex")
(org-format-latex-options
 '(:foreground default
               :background default
               :scale 1.4
               :html-foreground "Black"
               :html-background "Transparent"
               :html-scale 1.0
               :matchers ("begin" "$1" "$" "$$" "\\(" "\\[")))
  ;; Use org-agenda-file-to-front (C-c [) to add the current file to
  ;; the list of agenda files
  (org-directory "~/org")
  (org-default-notes-file (concat org-directory "/notes.org"))
  ;; Set to the name of the file where notes captured on mobile will
  ;; be stored
  ;; setsid required for xdg-open to work, from here
  ;; https://askubuntu.com/a/883905
  (org-file-apps '((auto-mode . emacs)
                   (directory . "setsid -w xdg-open %s")
                   ("\\.mm\\'" . default)
                   ("\\.x?html?\\'" . default)
                   ("\\.pdf\\'" . "setsid -w xdg-open %s")
                   (t . "setsid -w xdg-open %s")))
  ;; Don't keep indenting when adding whitespace
  (org-src-preserve-indentation t)
  ;; Tab indents using the src block's language's behaviour
  (org-src-tab-acts-natively t)
  ;; Don't ask for confirmation when evaluating src blocks
  (org-confirm-babel-evaluate nil)
  ;; Look across all agenda files for refiling
  (org-refile-targets '((org-agenda-files . (:maxlevel . 3))))
  ;; Allow specifying refile location using a full path including file name
  (org-refile-use-outline-path 'file)
  (org-outline-path-complete-in-steps nil)
  (org-completion-use-ido nil)

  ;; Automatically create a header if it doesn't already exist in the refile target path
  (org-refile-allow-creating-parent-nodes t)

  ;; Don't start clock from the previous clock out
  (org-clock-continuously nil)
  ;; Save clock history and the current clock when emacs closes
  (org-clock-persist t)

  (org-M-RET-may-split-line nil)

  ;; Start agenda on current day
  (org-agenda-start-on-weekday nil)
  ;; Don't show inline images with their actual width
  (org-image-actual-width nil)

  (org-catch-invisible-edits 'error)
  (org-export-allow-bind-keywords t)
  #+end_src

****** Capture Templates
  #+begin_src emacs-lisp
(org-capture-templates
 '(("t" "Todo" entry (file+headline "" "Tasks")
    "* TODO %?\n  %i\n")
   ("n" "Note" entry (file+headline "" "Quick Notes")
    "* %U\n%?\n")
   ("m" "Meeting" entry (file+headline "mlabs.org" "Meetings")
    "* %U\n%?\n" :prepend t)
   ))
#+end_src

****** Agenda custom commands
#+begin_src emacs-lisp
(org-agenda-custom-commands
 '(("p" "Personal" todo ""
    ((org-agenda-category-filter-preset '("+calum"))
     (org-super-agenda-groups calum/todo-super-agenda-groups)
     ))
   ("w" . "MLabs")
   ("wc" "CTL" todo ""
    ((org-agenda-category-filter-preset '("+ctl"))
     (org-agenda-files '("~/org/mlabs.org"))
     (org-super-agenda-groups calum/todo-super-agenda-groups)
     ))
   ("ww" "Other" todo ""
    ((org-agenda-category-filter-preset '("+mlabs"))
     (org-agenda-files '("~/org/mlabs.org"))
     (org-super-agenda-groups calum/todo-super-agenda-groups)
     ))
   ("s" . "School")
   ("sd" "Today School Agenda" agenda ""
    ((org-agenda-span 1)
     ))
   ("so" "One Week School Agenda" agenda ""
    ((org-agenda-span 7)
     ))
   ("st" "Two Week School Agenda" agenda ""
    ((org-agenda-span 14)
     ))
   ("ss" "School Agenda" agenda ""
    ((org-agenda-span 21)
     ))
   ("sm" "School Tasks without Assessments" todo ""
    ((org-agenda-category-filter-preset '("+school" "-assessments"))
     (org-agenda-files '("~/org/school.org"))
     (org-super-agenda-groups calum/todo-super-agenda-groups)
     ))
   ("sn" "School Tasks with Assessments" todo ""
    ((org-agenda-category-filter-preset '("+school" "+assessments"))
     (org-agenda-files '("~/org/school.org"))
     (org-super-agenda-groups calum/todo-super-agenda-groups)
     ))
   ("u" "Unscheduled TODO" todo ""
    ((org-agenda-skip-function '(org-agenda-skip-entry-if 'timestamp))
     (org-agenda-files '("~/org/school.org"))
     (org-super-agenda-groups calum/todo-super-agenda-groups)
     ))))
#+end_src

***** Config
#+begin_src emacs-lisp
:config
(make-directory org-directory t)

(org-link-set-parameters "editpdf"
                         :follow (lambda (path)
                                   (start-process "" nil
                                                  "xournalpp" (expand-file-name path)))
                         :complete 'org-link-complete-file)


(org-clock-persistence-insinuate)

;; After refiling something, save all the buffers automatically
(advice-add 'org-refile :after #'(lambda (&rest _)
                                   (org-save-all-org-buffers)))

(org-babel-do-load-languages
 'org-babel-load-languages '((emacs-lisp . t)
                             (python . t)
                             (R . t)))
;; Allow for jumping back after jupming to src block head
(calum/advise-push-mark-before 'org-babel-goto-src-block-head)
#+end_src

*** Org Mobile
#+begin_src emacs-lisp
(use-package org-mobile
  :after org
  :ensure nil
  :custom
  (org-mobile-inbox-for-pull org-default-notes-file)
  :preface
  (defvar org-mobile-directory "~/Dropbox/Apps/MobileOrg")
  :config
  (make-directory org-mobile-directory t)
  )
#+end_src

*** Org Aesthetics w/ Org Modern
Config from https://github.com/minad/org-modern
#+begin_src emacs-lisp
(use-package org-modern
  :custom
  (org-tags-column 0)
  (org-auto-align-tags nil)
  (org-hide-emphasis-markers t)
  (org-agenda-tags-column 0)
  (org-agenda-block-separator ?─)
  :config
  (modify-all-frames-parameters
   '((right-divider-width . 0)
     (internal-border-width . 10)))
  (dolist (face '(window-divider
                  window-divider-first-pixel
                  window-divider-last-pixel))
    (face-spec-reset-face face)
    (set-face-foreground face (face-attribute 'default :background)))
  (set-face-background 'fringe (face-attribute 'default :background))
  (global-org-modern-mode))
#+end_src

*** Org Aesthetics w/ Superstar
Show nicer bullet points for headers: https://github.com/integral-dw/org-superstar-mode

Trying out [[*Org Aesthetics w/ Org Modern][Org Modern]] instead.

#+begin_src emacs-lisp
(use-package org-superstar
  :disabled
  :after org
  :preface
  (defun superstar-auto-lightweight-mode ()
    "Start Org Superstar differently depending on the number of lists items. From https://github.com/integral-dw/org-superstar-mode#fast-plain-list-items"
    (let ((list-items
           (count-matches "^[ \t]*?\\([+-]\\|[ \t]\\*\\)"
                          (point-min) (point-max))))
      (unless (< list-items 100)
        (org-superstar-toggle-lightweight-lists)))
    (org-superstar-mode))
  :hook
  (org-mode . superstar-auto-lightweight-mode)
  :custom-face
  (org-superstar-first ((nil :foreground "#B48EAD")))
  :custom
  ;; Set different bullets, with one getting a terminal fallback.
  (org-superstar-headline-bullets-list '("◉" ("🞛" ?◈) "○" "▷"))
  ;; Don't show headline bullets
  ;; (org-superstar-headline-bullets-list nil)
  ;; Set up a different marker for graphic display.
  (org-superstar-first-inlinetask-bullet ?🞸)
  ;; Stop cycling bullets to emphasize hierarchy of headlines.
  (org-superstar-cycle-headline-bullets nil)
  (org-superstar-leading-bullet ?\s)
  (org-superstar-item-bullet-alist
   '((?* . ?•)
     (?+ . ?–)
     (?- . ?➤)))
  (org-superstar-special-todo-items t)
  (org-superstar-remove-leading-stars nil)
  (org-indent-mode-turns-on-hiding-stars nil)
  )
#+end_src

*** Org Inlinetask
https://github.com/amluto/org-mode/blob/master/lisp/org-inlinetask.el
#+begin_src emacs-lisp
(use-package org-inlinetask
  :after org
  :ensure nil
  :custom
  (org-inlinetask-show-first-star t)
  :custom-face
  (org-inlinetask ((nil :foreground nil :inherit 'bold))))
#+end_src

*** Org Indent
[[https://emacs.stackexchange.com/a/22552][Org-indent must be diminished after loading.]]
#+begin_src emacs-lisp
(use-package org-indent
  :disabled
  :if (not calum/magit-mode)
  :ensure nil
  :delight org-indent-mode)
#+end_src

*** Exporters
#+begin_src emacs-lisp
(require 'ox-md)
(use-package ox-gfm)
(use-package ox-json)
(use-package ox-ravel
  :load-path "/home/calum/.config/emacs/manual-plugins/ox-ravel")
(use-package ox-ipynb
  :load-path "/home/calum/.config/emacs/manual-plugins/ox-ipynb")
#+end_src

**** Citations
#+begin_src emacs-lisp
(use-package oc-basic
  :ensure nil
  :config
  (require 'oc-natbib)
  )
#+end_src

**** Org Latex Export
#+begin_src emacs-lisp
(require 'ox-latex)
(add-to-list 'org-latex-classes
             '("acmart"
               "\\documentclass[manuscript,screen]{acmart}
               [NO-DEFAULT-PACKAGES]"
               ("\\section{%s}" . "\\section*{%s}")
               ("\\subsection{%s}" . "\\subsection*{%s}")
               ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
               ("\\paragraph{%s}" . "\\paragraph*{%s}")
               ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
(add-to-list 'org-latex-classes
             '("awesome-cv"
               "\\documentclass[11pt, a4paper]{awesome-cv}
               [NO-DEFAULT-PACKAGES]"
               ("\\cvsection{%s}" . "\\cvsection*{%s}")
               ("\\cvparagraph{%s}" . "\\cvparagraph*{%s}")))
(add-to-list 'org-latex-classes
             '("cpsc433"
               "\\documentclass[11pt, a4paper]{article}
               \\usepackage[margin=0.9in,bmargin=1.0in,tmargin=1.0in]{geometry}
               \\newcommand{\\N}{\\mathbb{N}}
               \\newcommand{\\Z}{\\mathbb{Z}}
               \\newcommand{\\As}{A_{\\text{set}}}
               \\newcommand{\\Ss}{S_{\\text{set}}}
               \\newcommand{\\Ts}{T_{\\text{set}}}
               \\newcommand{\\Ps}{P_{\\text{set}}}
               \\newcommand{\\Ks}{K_{\\text{set}}}
               \\newcommand{\\Gs}{G_{\\text{set}}}
               \\newcommand{\\fv}{f_{\\text{Wert}}}
               \\newcommand{\\fs}{f_{\\text{select}}}
               \\newcommand{\\Ext}{\\text{Ext}}
               \\newcommand{\\Env}{\\text{Env}}
               \\newcommand{\\Inss}{\\text{Ins}_{set}}
               \\newcommand{\\Prob}{\\mathsf{Prob}}
               \\newcommand{\\Div}{\\mathsf{Div}}
               \\newcommand{\\Andmodel}{\\mathsf{A}_{\\wedge}}
               \\newcommand{\\Andstate}{\\mathsf{S}_{\\wedge}}
               \\newcommand{\\Andtrans}{\\mathsf{T}_{\\wedge}}
               \\newcommand{\\Anderw}{\\mathsf{Erw}_{\\wedge}}
               \\newcommand{\\Anderws}{\\mathsf{Erw}^{*}_{\\wedge}}
               \\newcommand{\\Atree}{\\mathsf{Atree}}
               \\newcommand{\\fleaf}{f_{\\mathsf{leaf}}}
               \\newcommand{\\ftrans}{f_{\\mathsf{trans}}}
               \\newcommand{\\pr}{\\mathsf{pr}}
               \\newcommand{\\sol}{\\mathsf{sol}}
               \\newcommand{\\yes}{\\mathsf{yes}}
               \\newcommand{\\Courses}{\\mathsf{Courses}}
               \\newcommand{\\Labs}{\\mathsf{Labs}}
               \\newcommand{\\Slots}{\\mathsf{Slots}}
               \\newcommand{\\coursemax}{\\mathsf{coursemax}}
               \\newcommand{\\labmax}{\\mathsf{labmax}}
               \\newcommand{\\assign}{\\mathsf{assign}}
               \\newcommand{\\BestCase}{\\mathsf{BestCase}}
               \\newcommand{\\Valid}{\\mathsf{Valid}}
               \\newcommand{\\Complete}{\\mathsf{Complete}}
               \\newcommand{\\Possibilities}{\\mathsf{Possibilities}}
               \\newcommand{\\Depth}{\\mathsf{Depth}}
               \\newcommand{\\theTreeSoFar}{\\mathsf{theTreeSoFar}}
               \\newcommand{\\Constr}{\\mathsf{Constr}}
               \\newcommand{\\Eval}{\\mathsf{Eval}}
               \\usepackage[shortcuts]{extdash} % allow hyphenation with \\-/
               \\newcommand{\\ncompat}{\\mathsf{not\\-/compat}}
               \\newcommand{\\partassign}{\\mathsf{partassign}}
               \\newcommand{\\unwanted}{\\mathsf{unwanted}}
               \\newcommand{\\coursemin}{\\mathsf{coursemin}}
               \\newcommand{\\labmin}{\\mathsf{labmin}}
               \\newcommand{\\pencoursemin}{\\mathsf{pen\\_coursemin}}
               \\newcommand{\\penlabmin}{\\mathsf{pen\\_labmin}}
               \\newcommand{\\pref}{\\mathsf{preference}}
               \\newcommand{\\pair}{\\mathsf{pair}}
               \\newcommand{\\pennotpaired}{\\mathsf{pen\\_notpaired}}
               \\newcommand{\\pensection}{\\mathsf{pen\\_section}}
               \\usepackage{fontspec}
               \\usepackage{unicode-math}
               \\usepackage{amsmath}
               \\usepackage{hyperref}
               \\usepackage{braket}
               \\usepackage{amsthm}
               \\theoremstyle{definition}
               \\newtheorem{defn}{Definition}[section]
               [NO-DEFAULT-PACKAGES]
               "
               ("\\section{%s}" . "\\section*{%s}")
               ("\\subsection{%s}" . "\\subsection*{%s}")
               ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
               ("\\paragraph{%s}" . "\\paragraph*{%s}")
               ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
(add-to-list 'org-latex-classes
             '("cpsc413"
               "\\documentclass[11pt, a4paper]{article}
               \\usepackage[margin=0.9in,bmargin=1.0in,tmargin=1.0in]{geometry}
               \\usepackage[ruled,linesnumbered]{algorithm2e}
               \\usepackage{amsmath}
               \\usepackage{amsthm}
               \\usepackage{hyperref}
               \\theoremstyle{definition}
               \\newcommand{\\N}{\\mathbb{N}}
               \\newcommand{\\Z}{\\mathbb{Z}}
               \\newtheorem{defn}{Definition}[section]
               \\newtheorem{lemma}{Lemma}[section]
               \\newtheorem{property}{Property}[section]
               \\newtheorem{proposition}{Proposition}[section]
               \\theoremstyle{remark}
               \\newtheorem*{remark}{Remark}
               \\SetKwComment{Comment}{/* }{ */}
               \\newcommand{\\pluseq}{\\mathrel{+}=}
               \\newcommand{\\minuseq}{\\mathrel{-}=}
               \\newcommand{\\var}{\\texttt}
               \\newcommand{\\NP}{\\mathcal{NP}}
               \\newcommand{\\pred}{\\leq_P}
               \\usepackage{mathtools}
               \\DeclarePairedDelimiter\\ceil{\\lceil}{\\rceil}
               \\DeclarePairedDelimiter\\floor{\\lfloor}{\\rfloor}
               "
               ("\\section{%s}" . "\\section*{%s}")
               ("\\subsection{%s}" . "\\subsection*{%s}")
               ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
               ("\\paragraph{%s}" . "\\paragraph*{%s}")
               ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
#+end_src

*** Org Contrib
To allow for ignoring headlines with an "ignore" tag in when exporting
from Org Mode, from [[https://emacs.stackexchange.com/a/41685][here]].
#+begin_src emacs-lisp
(use-package org-contrib
  :config
  (require 'ox-extra)
  (ox-extras-activate '(ignore-headlines))
  )
#+end_src

*** Org Download
Call ~org-download-clipboard~ to paste the most recent screenshot.
#+begin_src emacs-lisp
(use-package org-download
  :config
  (setq-default org-download-image-dir "screenshots")
  (setq org-download-screenshot-method "xclip"
        org-download-display-inline-images nil
        org-download-image-org-width 900))
#+end_src

*** Org Super Agenda
[[https://github.com/alphapapa/org-super-agenda][Org super agenda]] for organizing the agenda view in different ways.
#+begin_src emacs-lisp
(use-package org-super-agenda
  :if (not calum/magit-mode)
  :after org
  :general
  (:keymaps 'org-super-agenda-header-map
            "<tab>" 'origami-toggle-node
            "j" nil
            "k" nil
            "SPC" nil)
  :config
  (setq org-super-agenda-groups
        '((:name "" :time-grid t)
          (:auto-outline-path t)))
  ;; Note: To get the empty group hiding to work, I had to add the following line to org-super-agenda.el after line 308 in org-super-agenda--make-agenda-header:
  ;; (put-text-property 0 (length header) 'org-super-agenda-header t header)
  ;; This is because the org-super-agenda--hide-or-show-groups function relies on the text property, and line 308 did not seem to be adding the property correctly
  ;; After editing that file, run byte-recompile-directory
  (setq org-super-agenda-hide-empty-groups t)
  (org-super-agenda-mode 1))
#+end_src

*** Org Journal
#+begin_src emacs-lisp
(use-package org-journal
  :custom
  (org-journal-dir "~/org/journal/")
  (org-journal-file-type 'weekly)
  :config
  (setq org-crypt-key "Calum Sieppert <sieppertcalum@gmail.com>"
        org-tags-exclude-from-inheritance '("crypt")))
#+end_src

*** Org Appear
https://github.com/awth13/org-appear

Useful for editing org mode hidden entities, like emphasis markers.
#+begin_src emacs-lisp
(use-package org-appear
  :hook
  (org-mode . org-appear-mode)
  :custom
  (org-appear-inside-latex t)
  (org-appear-autosubmarkers t))
#+end_src
** Snippets with tempel
- https://github.com/minad/tempel
- https://github.com/Crandel/tempel-collection
  - https://github.com/Crandel/tempel-collection/blob/main/templates/org.eld
  - https://github.com/Crandel/tempel-collection/blob/main/templates/fundamental.eld
  - https://github.com/Crandel/tempel-collection/blob/main/templates/emacs-lisp.eld
#+begin_src emacs-lisp
(use-package tempel
  :preface
  (defun calum/edit-snippets ()
    (interactive)
    (chezmoi-find (concat user-emacs-directory "templates")))
  (defun tempel-setup-capf ()
    ;; Add the Tempel Capf to `completion-at-point-functions'.
    ;; `tempel-expand' only triggers on exact matches. Alternatively use
    ;; `tempel-complete' if you want to see all matches, but then you
    ;; should also configure `tempel-trigger-prefix', such that Tempel
    ;; does not trigger too often when you don't expect it. NOTE: We add
    ;; `tempel-expand' *before* the main programming mode Capf, such
    ;; that it will be tried first.
    (setq-local completion-at-point-functions
                (cons #'tempel-expand
                      completion-at-point-functions)))
  (defun tempel-reload ()
    "From https://github.com/minad/tempel/issues/74"
    (interactive)
    (setq tempel--path-templates nil))
  :general
  (calum/leader-def
    "M t" 'tempel-insert
    "M r" 'tempel-reload
    "M s" 'calum/edit-snippets
    )
  :hook
  (prog-mode . tempel-setup-capf)
  (text-mode . tempel-setup-capf))

(use-package tempel-collection)
#+end_src

** Completion and search
*** Minibuffer completion with consult
#+begin_src emacs-lisp
(use-package consult
  :general
  (calum/leader-def
    "b" 'consult-buffer)
  ;; C-c bindings (mode-specific-map)
  ;; ("C-c h" 'consult-history) ; Conflict with meow C-h- prefix
  ;; ("C-c m" 'consult-mode-command) ; Conflicts with meow M- prefix
  ;; ("C-c k" 'consult-kmacro) ; Conflicts with meow SPC-k mapping
  ;; C-x bindings (ctl-x-map)
  ("C-x M-:" 'consult-complex-command) ;; orig. repeat-complex-command
  ("C-x C-b" nil)
  ("C-x C-b" 'consult-bookmark)
  ("C-x 4 b" 'consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
  ("C-x 5 b" 'consult-buffer-other-frame) ;; orig. switch-to-buffer-other-frame
  ("C-x m" 'consult-man)
  ;; Custom M-# bindings for fast register access
  ("M-#" 'consult-register-load)
  ("M-'" 'consult-register-store) ;; orig. abbrev-prefix-mark (unrelated)
  ("C-M-#" 'consult-register)
  ;; Other custom bindings
  ("M-y" 'consult-yank-pop)     ;; orig. yank-pop
  ("<help> a" 'consult-apropos) ;; orig. apropos-command
  ;; M-g bindings (goto-map)
  ("M-g e" 'consult-compile-error)
  ("M-g f" 'consult-flymake)     ;; Alternative: consult-flycheck
  ("M-g g" 'consult-goto-line)   ;; orig. goto-line
  ("M-g M-g" 'consult-goto-line) ;; orig. goto-line
  ("M-g o" 'consult-org-heading)
  ("M-g a" 'consult-org-agenda)
  ("M-g j" 'consult-mark)
  ("M-g k" 'consult-global-mark)
  ("M-g i" 'consult-imenu)
  ("M-g I" 'consult-imenu-multi)
  ;; M-s bindings (search-map)
  ("M-s d" 'consult-find)
  ("M-s D" 'consult-locate)
  ("M-s g" 'consult-grep)
  ("M-s G" 'consult-git-grep)
  ("M-s r" 'consult-ripgrep)
  ("M-s l" 'consult-line)
  ("M-s L" 'consult-line-multi)
  ("M-s m" 'consult-multi-occur)
  ("M-s k" 'consult-keep-lines)
  ("M-s u" 'consult-focus-lines)
  ;; Isearch integration
  ("M-s e" 'consult-isearch-history)
  (:keymaps 'isearch-mode-map
            "M-e" 'consult-isearch-history ;; orig. isearch-edit-string
            "M-s e" 'consult-isearch-history ;; orig. isearch-edit-string
            )
  ;; Minibuffer history
  (:keymaps 'minibuffer-local-map
            "M-s" 'consult-history ;; orig. next-matching-history-element
            "M-r" 'consult-history) ;; orig. previous-matching-history-element
  :init
  ;; Optionally configure the register formatting. This improves the register
  ;; preview for `consult-register', `consult-register-load',
  ;; `consult-register-store' and the Emacs built-ins.
  (setq register-preview-delay 0.5
        register-preview-function #'consult-register-format)

  ;; Optionally tweak the register preview window.
  ;; This adds thin lines, sorting and hides the mode line of the window.
  (advice-add #'register-preview :override #'consult-register-window)

  ;; Use Consult to select xref locations with preview
  (setq xref-show-xrefs-function #'consult-xref
        xref-show-definitions-function #'consult-xref)

  :config

  ;; Optionally configure preview. The default value
  ;; is 'any, such that any key triggers the preview.
  ;; (setq consult-preview-key 'any)
  ;; (setq consult-preview-key (kbd "M-."))
  ;; (setq consult-preview-key (list (kbd "<S-down>") (kbd "<S-up>")))
  ;; For some commands and buffer sources it is useful to configure the
  ;; :preview-key on a per-command basis using the `consult-customize' macro.
  (consult-customize
   consult-theme
   :preview-key '(:debounce 0.2 any)
   consult-ripgrep consult-git-grep consult-grep
   consult-bookmark consult-recent-file consult-xref
   consult--source-bookmark consult--source-recent-file
   consult--source-project-recent-file
   :preview-key (kbd "M-."))

  ;; Optionally configure the narrowing key.
  ;; Both < and C-+ work reasonably well.
  (setq consult-narrow-key (kbd "C-+"))

  ;; By default `consult-project-function' uses `project-root' from project.el.
  ;; Optionally configure a different project root function.
  (autoload 'projectile-project-root "projectile")
  (setq consult-project-function (lambda (_) (projectile-project-root))))
#+end_src
**** Consult extensions
#+begin_src emacs-lisp
(use-package consult-projectile
  :config
  (setq consult-projectile-sources
        '(consult-projectile--source-projectile-buffer
          consult-projectile--source-projectile-file
          consult-projectile--source-projectile-recentf
          consult-projectile--source-projectile-dir
          consult-projectile--source-projectile-project
          )))
#+end_src

#+begin_src emacs-lisp
(use-package consult-dir
  :ensure t
  :bind (("C-x C-d" . consult-dir)
         :map minibuffer-local-map
         ("C-x C-d" . consult-dir)
         ("C-x C-j" . consult-dir-jump-file))
  :config
  (setq consult-dir-project-list-function #'consult-dir-projectile-dirs))
#+end_src

#+begin_src emacs-lisp
(use-package wgrep)
#+end_src

#+begin_src emacs-lisp
(use-package consult-eglot)
#+end_src
*** Completion UI with vertico
[[https://github.com/minad/vertico][Vertical completion UI]]; [[https://github.com/minad/vertico/wiki][Wiki]]
#+begin_src emacs-lisp
(use-package vertico
  :hook
  (minibuffer-setup . vertico-repeat-save)
  :general
  (:prefix "C->"
           "C->" 'vertico-repeat
           "C-S-s" 'vertico-repeat-select)
  :init
  (vertico-mode)

  ;; Optionally enable cycling for `vertico-next' and `vertico-previous'.
  (setq vertico-cycle t)

  (setq completion-in-region-function
        (lambda (&rest args)
          (apply (if vertico-mode
                     #'consult-completion-in-region
                   #'completion--in-region)
                 args)))

  ;; Show arrow before current candidate
  (advice-add #'vertico--format-candidate :around
              (lambda (orig cand prefix suffix index _start)
                (setq cand (funcall orig cand prefix suffix index _start))
                (concat
                 (if (= vertico--index index)
                     (propertize "» " 'face 'vertico-current)
                   "  ")
                 cand)))


  ;; Show input below candidates
  (defun vertico-bottom--display-candidates (lines)
    "Display LINES in bottom."
    (move-overlay vertico--candidates-ov (point-min) (point-min))
    (unless (eq vertico-resize t)
      (setq lines (nconc (make-list (max 0 (- vertico-count (length lines))) "\n") lines)))
    (let ((string (apply #'concat lines)))
      (add-face-text-property 0 (length string) 'default 'append string)
      (overlay-put vertico--candidates-ov 'before-string string)
      (overlay-put vertico--candidates-ov 'after-string nil))
    (vertico--resize-window (length lines)))

  (advice-add #'vertico--display-candidates :override #'vertico-bottom--display-candidates)
  :general
  (:keymaps 'vertico-map
            "C-' '" 'vertico-quick-exit
            "C-' j" 'vertico-quick-jump
            "C-' i" 'vertico-quick-insert
            )
  )
#+end_src
**** Marginalia
Enable richer annotations using the [[https://github.com/minad/marginalia][Marginalia]] package
#+begin_src emacs-lisp
(use-package marginalia
  :general
  (:keymaps 'minibuffer-local-map
            "M-A" 'marginalia-cycle)
  :custom
  (marginalia-command-categories
   '((projectile-find-file . project-file)
     (projectile-find-dir . project-file)
     (projectile-switch-project . file)
     (calum/select-project-magit . file)
     (magit-branch-and-checkout . git-branch)
     (magit-branch-or-checkout . git-branch)
     (magit-branch-checkout . git-branch)
     ))
  ;; The :init configuration is always executed (Not lazy!)
  :init
  ;; Must be in the :init section of use-package such that the mode gets
  ;; enabled right away. Note that this forces loading the package.
  (marginalia-mode)
  :preface
  (defun calum/git-num-unmerged-to-upstream (branch)
    (length (magit-git-lines "log" "--oneline" branch "--not"
                             (magit-get-upstream-branch branch))))

  (defun calum/git-branch-annotator (cand)
    ""
    (marginalia--fields
     ;; ((magit-get-upstream-branch cand) :width -15 :truncate 0.2)
     ;; ((magit-get-push-branch cand) :width -15 :truncate 0.5)
     ((if (magit-branch-merged-p cand)
          ""
        (concat (number-to-string (calum/git-num-unmerged-to-upstream cand))
                " "))
      :width -7)
     ((magit-rev-format " %h %s" cand) :width -35 :truncate 0.8 :face 'magit-dimmed)
     )
    )

  :config
  ;; Hack to make projectile use marginalia after switch-project: https://github.com/bbatsov/projectile/issues/1664#issuecomment-934630504
  (add-to-list 'marginalia-prompt-categories '("Find file:" . project-file))
  (add-to-list 'marginalia-prompt-categories '("\\<branch\\>" . git-branch))
  ;; magit-get-upstream-branch
  ;; magit-get-push-branch
  ;; magit-insert-upstream-branch-header
  ;; magit-insert-push-branch-header
  ;; magit-insert-head-branch-header
  ;; magit-insert-branch-description
  ;; (propertize (magit-rev-format "%h" target) 'font-lock-face 'magit-hash)
  (add-to-list 'marginalia-annotator-registry
               '(git-branch calum/git-branch-annotator none))
  )
#+end_src
**** Embark
https://github.com/oantolin/embark
#+begin_src emacs-lisp
(use-package embark
  :init
  ;; Optionally replace the key help with a completing-read interface
  (setq prefix-help-command #'embark-prefix-help-command)

  :general
  (:keymaps 'override "C-," 'embark-act-noquit)
  (:keymaps 'override "C-;" 'embark-dwim)
  ("C-h B" 'embark-bindings) ;; alternative for `describe-bindings'
  (:keymaps 'embark-general-map
            :prefix-command 'my-embark-actions-map
            :prefix "C-SPC"
            "c" '(calum/copy-embark-target-to-clipboard
                  :which-key "copy to clipboard"))

  :preface
  (defun calum/copy-embark-target-to-clipboard (target)
    "Copy the embark target to the system clipboard"
    (gui-set-selection 'CLIPBOARD target))
  (defun embark-act-noquit ()
    "Run action but don't quit the minibuffer afterwards."
    (interactive)
    (let ((embark-quit-after-action nil))
      (embark-act)))
  (defun embark-which-key-indicator ()
    "An embark indicator that displays keymaps using which-key.
The which-key help message will show the type and value of the
current target followed by an ellipsis if there are further
targets. https://github.com/oantolin/embark/wiki/Additional-Configuration#use-which-key-like-a-key-menu-prompt"
    (lambda (&optional keymap targets prefix)
      (if (null keymap)
          (which-key--hide-popup-ignore-command)
        (which-key--show-keymap
         (if (eq (plist-get (car targets) :type) 'embark-become)
             "Become"
           (format "Act on %s '%s'%s"
                   (plist-get (car targets) :type)
                   (embark--truncate-target (plist-get (car targets) :target))
                   (if (cdr targets) "…" "")))
         (if prefix
             (pcase (lookup-key keymap prefix 'accept-default)
               ((and (pred keymapp) km) km)
               (_ (key-binding prefix 'accept-default)))
           keymap)
         nil nil t (lambda (binding)
                     (not (string-suffix-p "-argument" (cdr binding))))))))

  (defun embark-hide-which-key-indicator (fn &rest args)
    "Hide the which-key indicator immediately when using the completing-read prompter."
    (which-key--hide-popup-ignore-command)
    (let ((embark-indicators
           (remq #'embark-which-key-indicator embark-indicators)))
      (apply fn args)))

  :config

  ;; Hide the mode line of the Embark live/completions buffers
  (add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none))))

  ;; Use a minimal indicator, and type C-h for help
  (setq embark-indicators
        '(embark-which-key-indicator
          embark-highlight-indicator
          embark-isearch-highlight-indicator))

  (advice-add #'embark-completing-read-prompter
              :around #'embark-hide-which-key-indicator)
  )

;; Consult users will also want the embark-consult package.
(use-package embark-consult
  :ensure t
  :after (embark consult)
  :demand t ; only necessary if you have the hook below
  ;; if you want to have consult previews as you move around an
  ;; auto-updating embark collect buffer
  :hook
  (embark-collect-mode . consult-preview-at-point-mode))
#+end_src
*** Completion style
https://github.com/oantolin/orderless

Config based on:
https://github.com/minad/consult/wiki#minads-orderless-configuration

Use %pattern to try out variants of characters in pattern, for example
%2 to match 2 or unicode superscript 2 (and probably other things).
#+begin_src emacs-lisp
(use-package orderless
  :config
  (defvar +orderless-dispatch-alist
    '((?% . char-fold-to-regexp)
      (?! . orderless-without-literal)
      (?`. orderless-initialism)
      (?= . orderless-literal)
      (?~ . orderless-flex)))

  (defun +orderless--suffix-regexp ()
    (if (and (boundp 'consult--tofu-char) (boundp 'consult--tofu-range))
        (format "[%c-%c]*$"
                consult--tofu-char
                (+ consult--tofu-char consult--tofu-range -1))
      "$"))

  ;; Recognizes the following patterns:
  ;; * ~flex flex~
  ;; * =literal literal=
  ;; * %char-fold char-fold%
  ;; * `initialism initialism`
  ;; * !without-literal without-literal!
  ;; * .ext (file extension)
  ;; * regexp$ (regexp matching at end)
  (defun +orderless-dispatch (word _index _total)
    (cond
     ;; Ensure that $ works with Consult commands, which add disambiguation suffixes
     ((string-suffix-p "$" word)
      `(orderless-regexp . ,(concat (substring word 0 -1) (+orderless--suffix-regexp))))
     ;; File extensions
     ((and (or minibuffer-completing-file-name
               (derived-mode-p 'eshell-mode))
           (string-match-p "\\`\\.." word))
      `(orderless-regexp . ,(concat "\\." (substring word 1) (+orderless--suffix-regexp))))
     ;; Ignore single !
     ((equal "!" word) `(orderless-literal . ""))
     ;; Prefix and suffix
     ((if-let (x (assq (aref word 0) +orderless-dispatch-alist))
          (cons (cdr x) (substring word 1))
        (when-let (x (assq (aref word (1- (length word))) +orderless-dispatch-alist))
          (cons (cdr x) (substring word 0 -1)))))))

  ;; Define orderless style with initialism by default
  (orderless-define-completion-style +calum/orderless-completion-style
    (orderless-matching-styles
     '(orderless-flex
       orderless-initialism
       orderless-prefixes
       orderless-literal
       orderless-regexp)))

  (setq completion-styles '(orderless basic)
        completion-category-defaults nil
        completion-category-overrides
        '((file (styles partial-completion)) ;; partial-completion is tried first
          (eglot (styles orderless))
          ;; (buffer (styles +calum/orderless-completion-style))
          ;; (command (styles +calum/orderless-completion-style))
          ;; (variable (styles +calum/orderless-completion-style))
          ;; (symbol (styles +calum/orderless-completion-style))
          )
        orderless-component-separator #'orderless-escapable-split-on-space ;; allow escaping space with backslash!
        orderless-style-dispatchers '(+orderless-dispatch)
        ))
#+end_src
*** Corfu for autocompletion
https://github.com/minad/corfu
https://github.com/minad/corfu/wiki

#+begin_src emacs-lisp
(use-package corfu
  :demand t
  ;; Optional customizations
  :custom
  (corfu-cycle t) ;; Enable cycling for `corfu-next/previous'
  ;; (corfu-auto t)                 ;; Enable auto completion
  ;; (corfu-separator ?\s)          ;; Orderless field separator
  (corfu-quit-at-boundary nil) ;; Never quit at completion boundary
  ;; (corfu-quit-no-match nil)      ;; Never quit, even if there is no match
  ;; (corfu-preview-current nil)    ;; Disable current candidate preview
  (corfu-preselect-first nil) ;; Disable candidate preselection
  ;; (corfu-on-exact-match nil)     ;; Configure handling of exact matches
  ;; (corfu-scroll-margin 5)        ;; Use scroll margin
  (corfu-popupinfo-delay nil)

  :general
  ("C-n" (general-predicate-dispatch nil
           (bound-and-true-p vertico--input) 'vertico-next
           t 'completion-at-point))
  (:keymaps 'corfu-map
            "C-n" 'corfu-next
            "C-p" 'corfu-previous
            "M-m" 'corfu-move-to-minibuffer
            "C-'" nil
            "C-' '" 'corfu-quick-complete
            "C-' i" 'corfu-quick-insert
            "C-' j" 'corfu-quick-jump
            [remap move-beginning-of-line] 'corfu-beginning-of-prompt
            [remap move-end-of-line] 'corfu-end-of-prompt
            ;; For popupinfo:
            ;; M-d, M-l, M-t: docs, location, toggle
            ;; scroll-other-window(-down) (C-M-v, C-M-S-v)
            )

  :preface
  (defun corfu-enable-always-in-minibuffer ()
    "Enable Corfu in the minibuffer if Vertico/Mct are not active. https://github.com/minad/corfu#completing-in-the-minibuffer"
    (unless (or (bound-and-true-p mct--active)
                (bound-and-true-p vertico--input))
      (setq-local corfu-echo-delay nil ;; Disable automatic echo and popup
                  corfu-popupinfo-delay nil)
      (corfu-mode 1)))

  (defun corfu-move-to-minibuffer ()
    "Function to transfer the current corfu completion list to the minibuffer. https://github.com/minad/corfu#transfer-completion-to-the-minibuffer"
    (interactive)
    (let ((completion-extra-properties corfu--extra)
          completion-cycle-threshold completion-cycling)
      (apply #'consult-completion-in-region completion-in-region--data)))

  (defun corfu-beginning-of-prompt ()
    "Move to beginning of completion input."
    (interactive)
    (corfu--goto -1)
    (goto-char (car completion-in-region--data)))

  (defun corfu-end-of-prompt ()
    "Move to end of completion input."
    (interactive)
    (corfu--goto -1)
    (goto-char (cadr completion-in-region--data)))
  :config
  (add-hook 'minibuffer-setup-hook #'corfu-enable-always-in-minibuffer 1)

  (global-corfu-mode)
  (corfu-echo-mode)
  (corfu-history-mode)
  (corfu-popupinfo-mode)
  )
#+end_src

**** Cape for autocomplete extensions
#+begin_src emacs-lisp
(use-package cape
  :general
  (:prefix "C-S-n"
           :prefix-command 'completions-map
           "p" 'completion-at-point ;; capf
           "t" 'complete-tag        ;; etags
           "d" 'cape-dabbrev        ;; or dabbrev-completion
           "h" 'cape-history
           "f" 'cape-file
           "k" 'cape-keyword
           "s" 'cape-symbol
           "a" 'cape-abbrev
           "i" 'cape-ispell
           "l" 'cape-line
           "w" 'cape-dict
           "n" 'tempel-complete
           "\\" 'cape-tex
           "_" 'cape-tex
           "^" 'cape-tex
           "&" 'cape-sgml
           "r" 'cape-rfc1345 ;; Complete unicode char using RFC 1345 mnemonics.
           )
  :config
  ;; Add `completion-at-point-functions', used by `completion-at-point'.
  (add-to-list 'completion-at-point-functions #'cape-dabbrev)
  (add-to-list 'completion-at-point-functions #'cape-file)

  ;; Sanitize the `pcomplete-completions-at-point' Capf. The Capf has
  ;; undesired side effects on Emacs 28 and earlier. From
  ;; https://github.com/minad/cape#other-capf-transformers
  (advice-add 'pcomplete-completions-at-point :around #'cape-wrap-silent)
  (advice-add 'pcomplete-completions-at-point :around #'cape-wrap-purify))
#+end_src

**** Kind icons for autocomplete icons
#+begin_src emacs-lisp
(use-package kind-icon
  :after corfu
  :custom
  (kind-icon-default-face 'corfu-default) ; to compute blended backgrounds correctly
  :config
  (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))
#+end_src
*** Project support
#+begin_src emacs-lisp
(use-package rg)
(use-package projectile
  :delight
  :ensure t
  :init
  (projectile-mode +1)
  :preface
  (defun calum/select-project-magit ()
    (interactive)
    (setq current-prefix-arg '(4))
    (call-interactively 'projectile-vc))
  :general
  (calum/leader-def
    :keymaps 'projectile-mode-map
    "p" '(:keymap projectile-command-map :which-key "project")
    "p w" 'calum/select-project-magit)
  :config
  (add-to-list 'projectile-other-file-alist '("purs" "js"))
  (add-to-list 'projectile-other-file-alist '("js" "purs"))
  )
(use-package treemacs-projectile)
#+end_src
*** TODO File manager
Note: for all-the-icons, needed to run ~all-the-icons-install-fonts~.
#+begin_src emacs-lisp
(use-package dirvish
  :init
  ;; Let Dirvish take over Dired globally
  (dirvish-override-dired-mode)
  :custom
  (dirvish-attributes '(all-the-icons file-size collapse subtree-state vc-state))
  (dirvish-bookmark-entries
   '(("h" "~/"                          "Home")
     ("d" "~/Downloads/"                "Downloads")))
  (dirvish-reuse-session t)
  :config
  (dirvish-peek-mode)
  (setq dired-dwim-target t)
  :bind
  ;; Bind `dirvish|dirvish-side|dirvish-dwim' as you see fit
  (:map dired-mode-map ; Dirvish respects all the keybindings in this map
   ("h" . dired-up-directory)
   ("j" . dired-next-line)
   ("k" . dired-previous-line)
   ("l" . dired-find-file)
   ("i" . wdired-change-to-wdired-mode)
   ("." . dired-omit-mode)
   ("b"   . dirvish-bookmark-jump)
   ("f"   . dirvish-file-info-menu)
   ("y"   . dirvish-yank-menu)
   ("N"   . dirvish-narrow)
   ("^"   . dirvish-history-last)
   ("s"   . dirvish-quicksort) ; remapped `dired-sort-toggle-or-edit'
   ("?"   . dirvish-dispatch)  ; remapped `dired-summary'
   ("TAB" . dirvish-subtree-toggle)
   ("SPC" . dirvish-history-jump)
   ("M-n" . dirvish-history-go-forward)
   ("M-p" . dirvish-history-go-backward)
   ("M-l" . dirvish-ls-switches-menu)
   ("M-m" . dirvish-mark-menu)
   ("M-f" . dirvish-toggle-fullscreen)
   ("M-s" . dirvish-setup-menu)
   ("M-e" . dirvish-emerge-menu)
   ("M-j" . dirvish-fd-jump)))
#+end_src

*** Icons
https://github.com/iyefrat/all-the-icons-completion/

#+begin_src emacs-lisp
(use-package all-the-icons
  :demand t
  :config
  (add-to-list 'all-the-icons-extension-icon-alist
               '("purs" all-the-icons-fileicon "purescript" :v-adjust 0.0 :height 1.0))
  )

(use-package all-the-icons-completion
  :after all-the-icons
  :config
  (all-the-icons-completion-mode)
  (add-hook 'marginalia-mode-hook #'all-the-icons-completion-marginalia-setup))
#+end_src
** Programming Languages/Tools
*** Python
#+begin_src emacs-lisp
(use-package python-mode
  :ensure nil
  :hook
  (python-mode . eglot-ensure))
#+end_src
*** Lisp
Setup completion for elisp to include words from the buffer and file
paths, based on https://github.com/minad/corfu/wiki#using-cape-to-tweak-and-combine-capfs.
#+begin_src emacs-lisp
(use-package emacs-lisp
  :ensure nil
  :preface
  (defun calum/format-top-level-sexp ()
    "Format the current top level sexp"
    (interactive)
    (let ((open-paren-in-column-0-is-defun-start t)
          (old-point (point)))
      (beginning-of-defun)
      (lispy-tab)
      (goto-char old-point)
      (recenter)))
  (defun calum/setup-elisp ()
    (setq-local completion-at-point-functions
                `(tempel-expand
                  ,(cape-super-capf
                    #'elisp-completion-at-point
                    #'cape-dabbrev)
                  cape-file)
                cape-dabbrev-min-length 4))
  :hook (emacs-lisp-mode . calum/setup-elisp)
  :general
  (calum/leader-def :keymaps 'emacs-lisp-mode-map
    "f" 'calum/format-top-level-sexp))
#+end_src

*** Haskell
#+begin_src emacs-lisp
(use-package haskell-mode
  :hook (haskell-mode . (lambda ()
                          (when (not (eq ".golden" (file-name-extension (buffer-file-name)))))
                          (eglot-ensure)))
  :config
  ;; A hack to make evil indent with "o" and "O" a little nicer by
  ;; indenting to the previous non-blank line instead of using the
  ;; haskell indent function
  (add-to-list 'indent-line-ignored-functions 'haskell-indentation-indent-line)
  (add-hook 'haskell-mode-hook 'haskell-auto-insert-module-template)
  ;; Use C-M-a/e/h to move to previous/next function/select the
  ;; current function
  (add-hook 'haskell-mode-hook 'haskell-decl-scan-mode)
  (require 'speedbar)
  (speedbar-add-supported-extension ".hs")
  (require 'haskell-interactive-mode)
  (require 'haskell-process)
  (add-hook 'haskell-mode-hook 'interactive-haskell-mode)
  (add-hook 'haskell-mode-hook 'haskell-collapse-mode)
  (add-hook 'haskell-mode-hook #'(lambda ()
                                  (setq-local tab-width 2)))
  (setq haskell-process-use-presentation-mode t
        haskell-interactive-mode-eval-mode 'haskell-mode))
(use-package direnv
  :custom (direnv-always-show-summary nil)
  :config
  (add-to-list 'direnv-non-file-modes 'haskell-interactive-mode)
  (direnv-mode))
#+end_src
*** Purescript
#+begin_src emacs-lisp
(use-package purescript-mode
  :hook
  (purescript-mode . eglot-ensure)
  (purescript-mode . (lambda ()
                       (turn-on-purescript-indentation)
                       (purescript-decl-scan-mode t)
                       (setq-local tab-width 2)))
  )
#+end_src
*** Dhall
#+begin_src emacs-lisp
(use-package dhall-mode
  :ensure t
  :mode "\\.dhall\\'")
#+end_src
*** Nix
#+begin_src emacs-lisp
(use-package nix-mode
  :hook
  (nix-mode . eglot-ensure)
  )
#+end_src
*** YAML
#+begin_src emacs-lisp
(use-package yaml-mode)
#+end_src
*** Language Server Protocol (LSP) with eglot
#+begin_src emacs-lisp
(use-package eglot
  :custom
  (eglot-autoshutdown t)
  (eglot-confirm-server-initiated-edits nil)
  :general
  (:keymaps 'eglot-mode-map
            "C-." 'eglot-code-actions)
  (calum/leader-def :keymaps 'eglot-mode-map
    "f" 'eglot-format
    )
  (calum/leader-def :keymaps 'eglot-mode-map
    :infix "i"
    :prefix-command 'eglot-actions-map
    "o" 'eglot-code-action-organize-imports
    "r" 'eglot-rename
    "f" 'eglot-format-buffer
    "q" 'eglot-code-action-quickfix
    "x" 'eglot-code-action-extract
    "n" 'eglot-code-action-inline
    "t" 'eglot-find-typeDefinition
    "w" 'eglot-code-action-rewrite
    "i" 'consult-imenu
    "z" '(nil :prefix-command lsp-server-actions)
    "z r" 'eglot-reconnect
    "z s" 'eglot-shutdown
    "z a" 'eglot-shutdown-all
    )
  :hook (eglot-managed-mode . tempel-setup-capf)
  :config
  (setq-default eglot-workspace-configuration
                '(:purescript (
                               :formatter "purs-tidy"
                               :censorWarnings ["WildcardInferredType"])
                  :haskell (:plugin (:stan (:globalOn :json-false)))))
  (add-to-list 'eglot-server-programs
               '(graphql-mode . ("graphql-lsp" "server" "--method=stream")))
  (add-to-list 'eglot-server-programs
               '(haskell-mode . ("haskell-language-server-wrapper" "--lsp"))))
#+end_src

*** Flex & Bison
#+begin_src emacs-lisp
(add-to-list 'auto-mode-alist '("\\.ll\\'" . c-mode))
(add-to-list 'auto-mode-alist '("\\.yy\\'" . c-mode))
#+end_src
*** Fish
#+begin_src emacs-lisp
(use-package fish-mode)
#+end_src
*** Docker
#+begin_src emacs-lisp
(use-package docker)
#+end_src
*** Typescript
#+begin_src emacs-lisp
(use-package typescript-mode
  :config
  (add-to-list 'auto-mode-alist '("\.tsx" . typescript-mode)))
#+end_src
*** Markdown
#+begin_src emacs-lisp
(use-package markdown-mode
  :hook
  (markdown-mode . imenu-add-menubar-index)
  (markdown-mode . visual-line-mode)
  (markdown-mode . visual-fill-column-mode)
  :config
  (setq imenu-auto-rescan t))
#+end_src
*** GraphQL
#+begin_src emacs-lisp
(use-package graphql-mode
  :hook (graphql-mode . eglot-ensure))
(use-package request)
#+end_src
*** R
#+begin_src emacs-lisp
(use-package ess
  :hook (ess-r-mode . eglot-ensure))
#+end_src
*** Dart
#+begin_src emacs-lisp
(use-package dart-mode
  :hook
  (dart-mode . eglot-ensure))
#+end_src
*** JSON
#+begin_src emacs-lisp
(use-package json-mode)
(use-package json-navigator)
#+end_src

** Miscellaneous

*** Ledger
https://github.com/ledger/ledger-mode
https://github.com/atheriel/evil-ledger
#+begin_src emacs-lisp
(use-package ledger-mode
  :mode ("\\.dat\\'"
         "\\.ledger\\'")
  :custom (ledger-clear-whole-transactions t)
  :preface
  ; Clean up the ledger buffer before saving. `save-excursion' doesn't
  ; work for some reason.
  (defun calum/ledger-before-save-hook ()
    (when (eq major-mode 'ledger-mode)
      (let ((temp-point (point)))
        (when (buffer-modified-p)
          (with-demoted-errors "Error: %S" (ledger-mode-clean-buffer)))
        (goto-char temp-point)
        (recenter))))
  :config
  (add-hook 'before-save-hook #'calum/ledger-before-save-hook)
  (add-hook 'ledger-mode-hook #'ledger-flymake-enable))
#+end_src

*** Folding
#+begin_src emacs-lisp
(use-package origami
  :general
  (calum/leader-def
    :infix "z"
    :prefix-command 'folding-map
    "z" 'origami-recursively-toggle-node
    "o" 'origami-open-all-nodes
    "c" 'origami-open-all-nodes
    "n" 'origami-forward-fold-same-level
    "p" 'origami-backward-fold-same-level
    "u" 'origami-previous-fold
    "d" 'origami-forward-fold
    "/" 'origami-undo
    "y" 'origami-redo
    "r" 'origami-reset)
  :config
  (global-origami-mode))
#+end_src

*** PDFs
#+begin_src emacs-lisp
(use-package pdf-tools
  :config
  (add-to-list 'pdf-tools-enabled-modes 'pdf-view-themed-minor-mode))
#+end_src

*** Change highlighting with goggles
Briefly highlight undo, delete, etc: https://github.com/minad/goggles

#+begin_src emacs-lisp
(use-package goggles
  :delight
  :hook ((prog-mode text-mode) . goggles-mode)
  :config
  (setq-default goggles-pulse t))
#+end_src

*** Chezmoi
#+begin_src emacs-lisp
(use-package chezmoi
  :general
  (calum/leader-def
    :infix "d"
    :prefix-command 'chezmoi-actions-map
    "f" 'chezmoi-find
    "g" 'chezmoi-magit-status
    "s" 'chezmoi-write
    "d" 'chezmoi-diff
    "e" 'chezmoi-ediff
    "o" 'chezmoi-open-other
    "t" 'chezmoi-template-buffer-display
    ;; Always enable the mode, I rarely want to disable it
    "c" #'(lambda () (interactive) (chezmoi-mode 1))
    "m" 'chezmoi-mode)
  :config
  ;; Turn off ligatures because they show up poorly.
  (add-hook 'chezmoi-mode-hook #'(lambda () (when (require 'ligature)
                                              (ligature-mode (if chezmoi-mode 0 1)))))

  (setq-default chezmoi-template-display-p t) ;; Display template values in all source buffers.
  )
#+end_src

*** Diminish minor modes
#+BEGIN_SRC emacs-lisp
  (use-package delight
    :demand t)
#+END_SRC

*** Undoing

[[https://www.emacswiki.org/emacs/UndoTree][Undo Tree]] package for visualizing undo/redo chain and to allow evil to use ~C-r~.
#+begin_src emacs-lisp
(use-package undo-tree
  :delight undo-tree-mode
  :config
  (setq undo-tree-history-directory-alist '(("." . "~/.config/emacs/undotree")))
  (global-undo-tree-mode))
#+end_src

*** Which-key
Provides us with hints on available keystroke combinations.
#+BEGIN_SRC emacs-lisp
  (use-package which-key
    :delight which-key-mode
    :config
    (which-key-mode +1)
    (setq which-key-idle-delay 0.4
          which-key-idle-secondary-delay 0.4))
#+END_SRC

*** Restart Emacs
[[https://github.com/iqbalansari/restart-emacs][Package]] that allows for restarting Emacs by running ~restart-emacs~.
#+BEGIN_SRC emacs-lisp
(use-package restart-emacs
  ;; Restart with ctrl-super-r
  :general
  ("C-M-r" 'restart-emacs))
#+END_SRC

*** MRU Buffer Switching
[[https://www.emacswiki.org/emacs/iflipb][Package]] for flipping through buffers in most recently used order.
#+begin_src emacs-lisp
(use-package iflipb
  :config
  (setq iflipb-ignore-buffers (lambda (buffer-name)
                                (and (and
                                      (not (string-match-p "\*Org Agenda\*" buffer-name))
                                      (not (string-match-p "\*Code Review\*" buffer-name))
                                      (not (string-match-p "\*Org Src" buffer-name))
                                      (not (string-match-p "\*dashboard\*" buffer-name)))
                                     (string-match-p "^[*]" buffer-name))))
  ;; This should work everywhere, including magit buffers for example
  (general-def
    :keymaps 'override
    "C-<tab>" 'iflipb-next-buffer
    (if (featurep 'xemacs) (kbd "<C-iso-left-tab>") (kbd "<C-S-iso-lefttab>")) 'iflipb-previous-buffer))
#+end_src

*** Hydras
#+begin_src emacs-lisp
(use-package hydra
  :custom
  (lv-use-separator t)
  (hydra-look-for-remap t)
  :general
  ("<f2>" 'hydra-zoom/body)
  ("<f6>" 'hydra-multiple-cursors/body)
  ("<f8>" 'hydra-window/body)
  ("C-x SPC" 'hydra-rectangle/body)
  :preface
  (defun hydra-ex-point-mark ()
    "Exchange point and mark."
    (interactive)
    (if rectangle-mark-mode
        (rectangle-exchange-point-and-mark)
      (let ((mk (mark)))
        (rectangle-mark-mode 1)
        (goto-char mk))))

  (defun hydra-move-splitter-left (arg)
    "Move window splitter left."
    (interactive "p")
    (if (let ((windmove-wrap-around))
          (windmove-find-other-window 'right))
        (shrink-window-horizontally arg)
      (enlarge-window-horizontally arg)))

  (defun hydra-move-splitter-right (arg)
    "Move window splitter right."
    (interactive "p")
    (if (let ((windmove-wrap-around))
          (windmove-find-other-window 'right))
        (enlarge-window-horizontally arg)
      (shrink-window-horizontally arg)))

  (defun hydra-move-splitter-up (arg)
    "Move window splitter up."
    (interactive "p")
    (if (let ((windmove-wrap-around))
          (windmove-find-other-window 'up))
        (enlarge-window arg)
      (shrink-window arg)))

  (defun hydra-move-splitter-down (arg)
    "Move window splitter down."
    (interactive "p")
    (if (let ((windmove-wrap-around))
          (windmove-find-other-window 'up))
        (shrink-window arg)
      (enlarge-window arg)))
  :config
  (defhydra hydra-zoom ()
    "zoom"
    ("g" text-scale-increase "in")
    ("l" text-scale-decrease "out"))
  ;; Note: use "r" to start selection
  (defhydra hydra-rectangle (:body-pre (rectangle-mark-mode 1)
                                        :color pink
                                        :post (deactivate-mark))
    "
  ^_k_^     _d_elete    _s_tring
_h_   _l_   _o_k        _y_ank
  ^_j_^     _n_ew-copy  _r_eset
^^^^        _e_xchange  _u_ndo
^^^^        ^ ^         _x_kill
"
    ("h" rectangle-backward-char nil)
    ("l" rectangle-forward-char nil)
    ("k" rectangle-previous-line nil)
    ("j" rectangle-next-line nil)
    ("e" hydra-ex-point-mark nil)
    ("n" copy-rectangle-as-kill nil)
    ("d" delete-rectangle nil)
    ("r" (if (region-active-p)
             (deactivate-mark)
           (rectangle-mark-mode 1)) nil)
    ("y" yank-rectangle nil)
    ("u" undo nil)
    ("s" string-rectangle nil)
    ("x" kill-rectangle nil)
    ("o" nil nil))
  ;; https://github.com/abo-abo/hydra/wiki/Window-Management#deluxe-window-moving
  (defhydra hydra-window ()
    "
Movement^^        ^Split^         ^Switch^		^Resize^
----------------------------------------------------------------
_h_ ←           _v_ertical      _b_uffer		_q_ X←
_j_ ↓           _x_ horizontal	_f_ind files	_w_ X↓
_k_ ↑           _z_ undo        _a_ce 1		_e_ X↑
_l_ →           _Z_ reset       _s_wap		_r_ X→
_F_ollow		_D_lt Other     _S_ave
_SPC_ cancel	_o_nly this     _d_elete
"
    ("h" windmove-left)
    ("j" windmove-down)
    ("k" windmove-up)
    ("l" windmove-right)
    ("q" hydra-move-splitter-left)
    ("w" hydra-move-splitter-down)
    ("e" hydra-move-splitter-up)
    ("r" hydra-move-splitter-right)
    ("b" consult-buffer)
    ("f" consult-file)
    ("F" follow-mode)
    ("a" (lambda ()
           (interactive)
           (ace-window 1)
           (add-hook 'ace-window-end-once-hook
                     'hydra-window/body)))
    ("v" (lambda ()
           (interactive)
           (split-window-right)
           (windmove-right)))
    ("x" (lambda ()
           (interactive)
           (split-window-below)
           (windmove-down)))
    ("s" (lambda ()
           (interactive)
           (ace-window 4)
           (add-hook 'ace-window-end-once-hook
                     'hydra-window/body)))
    ("S" save-buffer)
    ("d" delete-window)
    ("D" (lambda ()
           (interactive)
           (ace-window 16)
           (add-hook 'ace-window-end-once-hook
                     'hydra-window/body)))
    ("o" delete-other-windows)
    ("z" (progn
           (winner-undo)
           (setq this-command 'winner-undo)))
    ("Z" winner-redo)
    ("SPC" nil))
  ;; https://github.com/abo-abo/hydra/wiki/multiple-cursors
  (defhydra hydra-multiple-cursors (:hint nil)
    "
 Up^^             Down^^           Miscellaneous           % 2(mc/num-cursors) cursor%s(if (> (mc/num-cursors) 1) \"s\" \"\")
------------------------------------------------------------------
 [_p_]   Next     [_n_]   Next     [_l_] Edit lines  [_0_] Insert numbers   [_C-n_] Cycle forward
 [_P_]   Skip     [_N_]   Skip     [_a_] Mark all    [_A_] Insert letters   [_C-p_] Cycle backward
 [_M-p_] Unmark   [_M-n_] Unmark   [_s_] Search      [_q_] Quit
 [_|_] Align with input CHAR       [Click] Cursor at point"
    ("C-n" mc/cycle-forward)
    ("C-p" mc/cycle-backward)
    ("l" mc/edit-lines :exit t)
    ("a" mc/mark-all-like-this :exit t)
    ("n" mc/mark-next-like-this)
    ("N" mc/skip-to-next-like-this)
    ("M-n" mc/unmark-next-like-this)
    ("p" mc/mark-previous-like-this)
    ("P" mc/skip-to-previous-like-this)
    ("M-p" mc/unmark-previous-like-this)
    ("|" mc/vertical-align)
    ("s" mc/mark-all-in-region-regexp :exit t)
    ("0" mc/insert-numbers :exit t)
    ("A" mc/insert-letters :exit t)
    ("<mouse-1>" mc/add-cursor-on-click)
    ;; Help with click recognition in this hydra
    ("<down-mouse-1>" ignore)
    ("<drag-mouse-1>" ignore)
    ("q" nil)))
#+end_src

*** Jumping with avy

#+begin_src emacs-lisp
(use-package avy
  :init
  (define-prefix-command 'calum/avy-map)
  :general
  (:keymaps 'calum/avy-map
            "C" 'avy-goto-char
            "c" 'avy-goto-char-timer
            "l" 'avy-goto-line
            "L" 'avy-goto-end-of-line
            "j" 'avy-goto-line-below
            "k" 'avy-goto-line-above
            "e" 'avy-goto-whitespace-end
            "[" 'avy-pop-mark
            "r" 'avy-resume
            "n" 'avy-next
            "p" 'avy-prev
            "f" 'calum/avy-goto-char-in-line)
  (:keymaps 'calum/avy-map
            :prefix "o"
            :prefix-command 'avy-org-command-map
            "h" 'avy-org-goto-heading-timer
            "r" 'avy-org-refile-as-child)
  (:keymaps 'calum/avy-map
            :prefix "y"
            :prefix-command 'avy-copy-command-map
            "l" 'avy-copy-line
            "r" 'avy-copy-region)
  (:keymaps 'calum/avy-map
            :prefix "<backspace>"
            :prefix-command 'avy-kill-command-map
            "r" 'avy-kill-region
            "l" 'avy-kill-whole-line)
  (:keymaps 'calum/avy-map
            :prefix "s"
            :prefix-command 'avy-save-command-map
            "r" 'avy-kill-ring-save-region
            "l" 'avy-kill-ring-save-whole-line)
  (:keymaps 'calum/avy-map
            :prefix "m"
            :prefix-command 'avy-move-command-map
            "r" 'avy-move-region
            "l" 'avy-move-line
            "t" 'avy-transpose-lines-in-region)
  :preface

  (defun calum/avy-goto-char-in-line (char)
    "Like the existing function, but fixes this issue: https://github.com/abo-abo/avy/issues/340"
    (interactive (list (read-char "char: " t)))
    (avy-with calum/avy-goto-char-in-line
      (avy-jump
       (regexp-quote (string char))
       :beg (line-beginning-position)
       :end (line-end-position))))

  :custom
  (avy-all-windows nil)
  (avy-style 'words)
  (avy-styles-alist '((calum/avy-goto-char-in-line . at)))
  (avy-indent-line-overlay t))
#+end_src

*** Zen Mode

#+begin_src emacs-lisp
(use-package writeroom-mode
  :config
  (setq writeroom-global-effects
        (remove 'writeroom-set-fullscreen
                (remove 'writeroom-set-alpha writeroom-global-effects))
        writeroom-width 100))
#+end_src


#  LocalWords:  tpope's Ido ido flx MRU LocalWords el

*** Ligatures
[[https://github.com/mickeynp/ligature.el]]
#+begin_src emacs-lisp
(use-package ligature
  :load-path "/home/calum/.config/emacs/manual-plugins/ligature.el"
  :config
  ;; Enable all JetBrains Mono ligatures in programming modes
  (ligature-set-ligatures 'prog-mode '("-|" "-~" "---" "-<<" "-<" "--" "->" "->>" "-->" "///" "/=" "/=="
                                      "/>" "//" "/*" "*>" "***" "*/" "<-" "<<-" "<=>" "<=" "<|" "<||"
                                      "<|||" "<|>" "<:" "<>" "<-<" "<<<" "<==" "<<=" "<=<" "<==>" "<-|"
                                      "<<" "<~>" "<=|" "<~~" "<~" "<$>" "<$" "<+>" "<+" "</>" "</" "<*"
                                      "<*>" "<->" "<!--" ":>" ":<" ":::" "::" ":?" ":?>" ":=" "::=" "=>>"
                                      "==>" "=/=" "=!=" "=>" "===" "=:=" "==" "!==" "!!" "!=" ">]" ">:"
                                      ">>-" ">>=" "=<<" ">=>" ">>>" ">-" ">=" "&&&" "&&" "|||>" "||>" "|>" "|]"
                                      "|}" "|=>" "|->" "|=" "||-" "|-" "||=" "||" ".." ".?" ".=" ".-" "..<"
                                      "..." "+++" "+>" "++" "[||]" "[<" "[|" "{|" "??" "?." "?=" "?:" "##"
                                      "###" "####" "#[" "#{" "#=" "#!" "#:" "#_(" "#_" "#?" "#(" ";;" "_|_"
                                      "__" "~~" "~~>" "~>" "~-" "~@" "$>" "^=" "]#"))
  ;; Enables ligature checks globally in all buffers. You can also do it
  ;; per mode with `ligature-mode'.
  (global-ligature-mode t))
#+end_src

*** Sudo edit
#+begin_src emacs-lisp
(use-package sudo-edit)
#+end_src

*** Minimap
#+begin_src emacs-lisp
(use-package minimap
  :custom (minimap-window-location 'right
           minimap-hide-cursor t))
#+end_src

*** Slack
See [[https://github.com/yuya373/emacs-slack#how-to-get-token-and-cookie][here]] for instructions on getting the slack token and cookie.
#+begin_src emacs-lisp
(use-package slack
  :commands (slack-start)
  :init
  (setq slack-buffer-emojify t) ;; if you want to enable emoji, default nil
  (setq slack-prefer-current-team t)
  :config
  (slack-register-team
   :name "mlabs-corp"
   :default t
   :token "xoxc-1974274253845-3554162517520-3557821842192-0105cdaec51cf0d48965904df6424bb1acae5d90f10d2f3d71d20008dafd1215"
   :cookie "xoxd-i0LaH9nsgPgXYDRi8Iz2%2BA7Xe2jNmLIAD0Ar5BjjOGgyYbvcYVsAdFFuEm0wQSU%2BDsbV24bbtmiF3zCY%2FucHc%2BOEly0d%2FlE6czE7Re%2BvPv4n%2FUJh8%2FK4OEg%2BIQR2Ibus2o0Ol8XII9ST%2BVPfuOsXvXnF0eTH1q%2F4gBVwQ1VCyIi5GktiX2jh8EZUSw%3D%3D"
   :subscribed-channels '(iohk)
   :full-and-display-names t)
)

(use-package alert
  :commands (alert)
  :init
  (setq alert-default-style 'notifier))
#+end_src

*** Open GitHub
#+begin_src emacs-lisp
(use-package git-link
  :preface
  (defun calum/git-link ()
    (interactive)
    (call-interactively 'git-link)
    (calum/copy-current-kill-to-clipboard))
  (defun calum/git-permalink ()
    (interactive)
    (let ((git-link-use-commit t))
      (calum/git-link))))
#+end_src

*** IMenu
https://github.com/bmag/imenu-list, show imenu in a sidebar
#+begin_src emacs-lisp
(use-package imenu-list
  :bind (("C-\"" . imenu-list-smart-toggle))
  :config
  (setq imenu-list-focus-after-activation t
        imenu-list-auto-resize nil))
#+end_src

*** Dashboard
#+begin_src emacs-lisp
(use-package dashboard
  :demand t
  :custom
  (dashboard-projects-backend 'projectile)
  (dashboard-center-content t)
  (dashboard-items '((recents . 5)
                     (bookmarks . 5)
                     (projects . 5)
                     (agenda . 5)))
  (dashboard-set-heading-icons t)
  (dashboard-set-file-icons t)
  (dashboard-set-navigator t)
  (dashboard-set-init-info t)
  (dashboard-week-agenda t)
  (dashboard-agenda-sort-strategy '(time-up))
  (dashboard-banner-logo-title nil)
  (dashboard-startup-banner 'logo)
  :config
  (dashboard-setup-startup-hook)
  (setq initial-buffer-choice (lambda ()
                                (get-buffer-create "*dashboard*")
                                (dashboard-refresh-buffer))))
#+end_src

*** Hungry delete
http://endlessparentheses.com/hungry-delete-mode.html
#+begin_src emacs-lisp
(use-package hungry-delete
  :delight
  :config
  (global-hungry-delete-mode))
#+end_src

*** Mosey
https://github.com/alphapapa/mosey.el
#+begin_src emacs-lisp
(use-package mosey
  :general
  ("C-a" 'mosey-backward-bounce)
  ("C-e" 'mosey-forward-bounce))
#+end_src

*** Aggresive indent
https://github.com/Malabarba/aggressive-indent-mode
#+begin_src emacs-lisp
(use-package aggressive-indent
  :config
  (global-aggressive-indent-mode))
#+end_src

*** Scroll on jump
#+begin_src emacs-lisp
(use-package scroll-on-jump
  :custom
  (scroll-on-jump-duration 0.4)
  (scroll-on-jump-smooth t)
  (scroll-on-jump-curve 'linear)
  :config
  (scroll-on-jump-advice-add meow-undo)
  (scroll-on-jump-advice-add undo-tree-redo)
  (scroll-on-jump-advice-add calum/meow-pop-to-mark)
  (scroll-on-jump-advice-add meow-beginning-of-thing)
  (scroll-on-jump-advice-add meow-end-of-thing)
  (scroll-on-jump-advice-add meow-cancel-selection)
  (scroll-on-jump-advice-add meow-search)
  (scroll-on-jump-advice-add meow-block)
  (scroll-on-jump-advice-add meow-to-block)
  (scroll-on-jump-advice-add meow-pop-selection)
  (scroll-on-jump-advice-add meow-find-ref)
  (scroll-on-jump-advice-add meow-pop-marker)
  (scroll-on-jump-with-scroll-advice-add scroll-down-command)
  (scroll-on-jump-with-scroll-advice-add scroll-up-command)
  (scroll-on-jump-with-scroll-advice-add recenter-top-bottom)
  )
#+end_src

*** Topsy
#+begin_src emacs-lisp
(use-package topsy
  :quelpa (topsy :fetcher github :repo "alphapapa/topsy.el")
  :hook (prog-mode . topsy-mode))
#+end_src

*** Expand region
https://github.com/magnars/expand-region.el
#+begin_src emacs-lisp
(use-package expand-region
  :general
  ("C-=" 'er/expand-region))
#+end_src

* Keybinds
- https://github.com/noctuid/general.el
- https://www.masteringemacs.org/article/mastering-key-bindings-emacs


- After the "/" is shifted version, e.g. for "backspace", "bksp-func/bksp-func-shifted"
- "fb" is "fallback", for meow fallback when there is no selection
- I reserve ctl+shift+alt for the OS level
- I need to add a way to type ctrl+escape to my keyboard


|            | normal                                    | Control                                | Alt                                         | Control+Alt                         | C-c/SPC                  | C-x             | Nav mode    |
|------------+-------------------------------------------+----------------------------------------+---------------------------------------------+-------------------------------------+--------------------------+-----------------+-------------|
|            | <6>                                       | <7>                                    | <3>                                         | <11>                                | <7>                      | <3>             | <8>         |
| q/Q        | meow-quit/meow-goto-line                  | emacs-surround/nil                     | fill-paragraph/nil                          | nil                                 |                          |                 | nil/-       |
| w/W        | meow-mark-word/meow-mark-symbol           | kill-region/nil                        | kill-ring-save/nil                          | append-next-kill                    | [[file:~/.local/share/chezmoi/private_dot_config/emacs/config.org::*Keybindings][windows-map]]              |                 | -/-         |
| e/E        | meow-next-word/meow-next-symbol           | move-end-of-line/nil                   | forward-sentence/nil                        | end-of-defun                        |                          |                 | -/-         |
| r/R        | meow-replace/meow-swap-grab               | isearch-backward/nil                   | move-to-window-line-top-bottom/nil          | restart-emacs                       |                          |                 | nil/nil     |
| t/T        | meow-till-expand/nil                      | transpose-chars/nil                    | transpose-words/nil                         | transpose-sexps                     | open-terminal            |                 | -/nil       |
| y/Y        | meow-save/meow-sync-grab                  | yank/nil                               | consult-yank-pop/nil                        | nil                                 |                          |                 | -/nil       |
| u/U        | meow-undo/undo-tree-redo                  | universal-argument/nil                 | upcase-word/nil                             | backward-up-list                    |                          |                 | nil/nil     |
| i/I        | meow-insert/meow-open-above               | TAB: indent-for-tab-command/nil        | tab-to-tab-stop/nil                         | complete-symbol                     | [[file:~/.local/share/chezmoi/private_dot_config/emacs/config.org::*Language Server Protocol (LSP)][lsp funcs]]                |                 | nil/nil     |
| o/O        | meow-block/meow-to-block                  | open-line/nil                          | nil/nil                                     | split-line                          | [[file:~/.local/share/chezmoi/private_dot_config/emacs/config.org::*Keybinds][org-actions-map]]          |                 | -/-         |
| p/P        | meow-yank/meow-paren-mode                 | previous-line/execute-extended-command | nil/nil                                     | previous-line                       | project funcs            |                 | nil/nil     |
| a/A        | meow-append/meow-open-below               | move-beginning-of-line/nil             | backward-sentence/nil                       | beginning-of-defun                  |                          |                 | nil/nil     |
| s/S        | meow-kill/nil                             | save-buffer/nil                        | consult searching/nil                       | isearch-forward-regexp              | [[file:~/.local/share/chezmoi/private_dot_config/emacs/config.org::*Spell Check][spell-check-map]]          |                 | -/nil       |
| d/D        | meow-delete/meow-kill-whole-line          | delete-char/nil                        | delete-word/nil                             | down-list                           | [[file:~/.local/share/chezmoi/private_dot_config/emacs/config.org::*Chezmoi][chezmoi funcs]]            |                 | nil/-       |
| f/F        | meow-find-expand/display-local-help       | forward-char/nil                       | forward-word/nil                            | forward-sexp                        | format buffer            |                 | -/nil       |
| g/G        | meow-cancel-selection/meow-grab           | keyboard-quit/nil                      | consult goto/nil                            | nil                                 | <meow C-M- prefix>       |                 | -/-         |
| h/H        | meow-left/meow-left-expand                | help-map/nil                           | mark-paragraph/nil                          | mark-defun                          | consult-history          |                 | -/-         |
| j/J        | meow-next/meow-next-expand                | electric-newline-and-maybe-indent/nil  | default-indent-new-line/nil                 | default-indent-new-line             |                          |                 | -/-         |
| k/K        | meow-prev/meow-prev-expand                | kill-line/nil                          | kill-sentence/nil                           | kill-sexp                           | consult-kmacro           |                 | -/-         |
| l/L        | meow-right/meow-right-expand              | recenter-top-bottom/nil                | downcase-word/nil                           | reposition-window                   |                          |                 | -/-         |
| z/Z        | calum/paren-map/meow-pop-selection        | suspend-frame/nil                      | zap-to-char/nil                             | nil                                 | folding actions          |                 | -/nil       |
| x/X        | meow-line/join-line                       | ctl-x-map/nil                          | execute-extended-command/-for-buffer        | nil                                 |                          |                 | -/nil       |
| c/C        | meow-change/comment-line                  | ctl-c-map/nil                          | capitalize-word/nil                         | meow-comment                        | [[file:~/.local/share/chezmoi/private_dot_config/emacs/config.org::*Cape for autocomplete extensions][completion funcs]]         |                 | nil/nil     |
| v/V        | meow-find-ref/meow-pop-marker             | scroll-up-command/nil                  | scroll-down-command/nil                     | scroll-other-window                 | calc-dispatch            |                 | -/-         |
| b/B        | meow-back-word/meow-back-symbol           | backward-char/nil                      | backward-word/nil                           | backward-sexp                       | consult-buffer           |                 | -/-         |
| n/N        | meow-search/meow-nav-mode                 | completion-at-point/completions-map    | nil/nil                                     | next-line                           |                          |                 | -/nil       |
| m/M        | meow-join/nil                             | RET: newline/nil                       | back-to-indentation/nil                     | nil                                 | meow meta key/misc funcs |                 | nil/nil     |
| tab        | indent-for-tab-command                    | iflipb-next/previous-buffer            | OS level                                    | nil                                 |                          |                 | nil         |
| space      | meow-keypad                               | set-mark-command/nil                   | just-one-space                              | mark-sexp                           |                          | rectangle hydra | -           |
| escape     | calum/meow-escape                         | nil/nil                                | prefix/nil                                  | nil                                 |                          |                 | normal-mode |
| return     |                                           | nil/nil                                | nil/nil                                     | nil                                 |                          |                 | nil         |
| backspace  |                                           | backward-delete-word/kill-whole-line   | nil/nil                                     | nil                                 |                          |                 | nil         |
| delete     |                                           | kill-word/nil                          | nil/nil                                     | nil                                 |                          |                 | nil         |
| ,/<        | meow-inner-of-thing/meow-pop-to-mark      | embark-act-noquit/nil                  | xref-pop-marker-stack/beginning-of-buffer   | nil/nil                             |                          |                 | -/-         |
| ./>        | meow-bounds-of-thing/repeat               | nil/"repeater" bindings                | xref-find-definitions/end-of-buffer         | xref-find-apropos/nil               |                          |                 | -/-         |
| //?        | meow-visit/nil                            | undo-tree-undo/undo-tree-redo          | dabbrev-expand/xref-find-references         | dabbrev-completion/nil              |                          |                 | -/nil       |
| ;/:        | meow-reverse/nil                          | embark-dwim/nil                        | comment-dwim/eval-expression                | iedit-execute-last-modification/nil |                          |                 | -/nil       |
| '/"        | avy-map/multiple-cursor-map               | nil/imenu-list-smart-toggle            | consult-register-store/nil                  | nil/nil                             |                          |                 | -/nil       |
| left/right |                                           | left/right-word/nil                    | nil/nil/nil/nil                             | forward-sexp/backward-sexp          |                          |                 | nil/nil     |
| up/down    |                                           | forward/backward-paragraph/nil         | nil/nil/nil/nil                             | backward-up-list/down-list          |                          |                 | nil/nil     |
| !/1        | nil/meow-expand-1                         | nil/digit-argument                     | shell-command/digit-argument                | nil/digit-argument                  | /meow-digit-argument     |                 | nil/-       |
| @/2        | nil/meow-expand-2                         | set-mark-command/digit-argument        | mark-word/digit-argument                    | mark-sexp/digit-argument            | /meow-digit-argument     |                 | nil/-       |
| #/3        | nil/meow-expand-3                         | nil/digit-argument                     | consult-register-load/digit-argument        | consult-register/digit-argument     | /meow-digit-argument     |                 | nil/-       |
| $/4        | query-replace-map/meow-expand-4           | nil/digit-argument                     | ispell-word/digit-argument                  | nil/digit-argument                  | /meow-digit-argument     |                 | nil/-       |
| %/5        | nil/meow-expand-5                         | nil/digit-argument                     | query-replace/digit-argument                | query-replace-regexp/digit-argument | /meow-digit-argument     |                 | nil/-       |
| ^/6        | nil/meow-expand-6                         | nil/digit-argument                     | delete-indentation/digit-argument           | nil/digit-argument                  | /meow-digit-argument     |                 | nil/-       |
| &/7        | nil/meow-expand-7                         | nil/digit-argument                     | async-shell-command/digit-argument          | nil/digit-argument                  | /meow-digit-argument     |                 | nil/-       |
| */8        | nil/meow-expand-8                         | nil/digit-argument                     | nil/digit-argument                          | nil/digit-argument                  | /meow-digit-argument     |                 | nil/-       |
| (/9        | nil/meow-expand-9                         | nil/digit-argument                     | insert-parentheses/digit-argument           | nil/digit-argument                  | /meow-digit-argument     |                 | nil/-       |
| )/0        | nil/meow-expand-0                         | nil/digit-argument                     | move-past-close-and-reindent/digit-argument | nil/digit-argument                  | /meow-digit-argument     |                 | nil/-       |
| \[/\]      | meow-beginning-of-thing/meow-end-of-thing | ESC/abort-recursive-edit               | nil/nil                                     | M-ESC/nil                           |                          |                 | -/-         |
| {/}        | nil/nil                                   | nil/nil                                | backward-/forward-paragraph                 | nil/nil                             |                          |                 | nil/nil     |
| <f2>       | text-scale hydra                          |                                        |                                             |                                     |                          |                 |             |
| <f3>       | macro-start                               |                                        |                                             |                                     |                          |                 |             |
| <f4>       | meow-kmacro-lines fb meow call kmacro     |                                        |                                             |                                     |                          |                 |             |
| <f5>       | meow-kmacro-matches                       |                                        |                                             |                                     |                          |                 |             |
| <f6>       | multiple cursors hydra                    |                                        |                                             |                                     |                          |                 |             |
| <f7>       | calum/edit-config                         |                                        |                                             |                                     |                          |                 |             |
| <f8>       | window hydra                              |                                        |                                             |                                     |                          |                 |             |
| <f9>       | nil                                       |                                        |                                             |                                     |                          |                 |             |
| <f10>      | nil                                       |                                        |                                             |                                     |                          |                 |             |
| <f11>      | nil                                       |                                        |                                             |                                     |                          |                 |             |
| <f12>      | nil                                       |                                        |                                             |                                     |                          |                 |             |
